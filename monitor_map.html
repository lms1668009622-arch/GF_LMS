<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>| 多模态视觉融合应用 </title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        .map-container { flex: 1; position: relative; }
        
        /* Map Picker Overlay (Deprecated / Removed Logic, kept for ref if needed but overlay is gone) */
        /* .map-marker and .map-range-circle styles are now used by Leaflet DivIcons */
        .map-marker {
            position: relative; /* Changed from absolute for Leaflet context */
            width: 20px;
            height: 20px;
            background: #ef4444;
            border: 2px solid white;
            border-radius: 50%;
            /* transform: translate(-50%, -50%); Handled by Leaflet iconAnchor */
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            pointer-events: none;
        }

        .map-marker::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        /* Deprecated styles handled by Leaflet L.circle now */
        /* .map-range-circle { ... } */

        @keyframes pulseRange {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        /* Layout Containers */
        .monitor-overlay-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            /* display: flex; */
            /* flex-direction: column; */
            /* gap: 16px; */
            /* align-items: flex-start; */
            z-index: 1000; /* Ensure overlay is above map */
            pointer-events: none; /* Let clicks pass through container area */
        }

        /* Re-enable pointer events for interactive children */
        .monitor-card, .detail-panel, .uav-card {
            pointer-events: auto;
        }

        .monitor-top-row {
            display: flex;
            gap: 16px;
            align-items: flex-start;
            position: relative;
        }

        /* Monitor Card Styles (Existing Updated) */
        .monitor-card {
            width: 341px;
            height: 263px;
            background: rgba(21, 44, 81, 0.79);
            border-radius: 4px;
            border: 1px solid var(--LineLine-color-border-2, #E2E8F0);
            color: white;
            overflow: hidden;
            font-family: "Microsoft YaHei", sans-serif;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        /* ... (Keep existing monitor header/body styles) ... */

        /* Detail Panel Styles (New) */
        .detail-panel {
            width: 300px;
            height: 400px;
            background: rgba(21, 44, 81, 0.95);
            border-radius: 4px;
            border: 1px solid #E2E8F0;
            color: white;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            display: none; /* Hidden by default */
            flex-direction: column;
            overflow: hidden;
            animation: slideInLeft 0.3s ease-out;
        }

        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .panel-header {
            padding: 10px 16px;
            background: #4a5b73;
            border-bottom: 1px solid #5c6f8a;
            font-weight: bold;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-close {
            cursor: pointer;
            color: #aebfd4;
        }
        .panel-close:hover { color: white; }

        .panel-body {
            padding: 16px;
            font-size: 13px;
            overflow-y: auto;
        }

        .detail-item {
            margin-bottom: 12px;
            border-bottom: 1px dashed rgba(255,255,255,0.1);
            padding-bottom: 8px;
        }
        .detail-item:last-child { border: none; }

        .d-label { color: #aebfd4; margin-bottom: 4px; display: block; }
        .d-value { color: white; line-height: 1.4; }

        /* UAV Dispatch Card Styles (New) */
        .uav-card {
            width: 341px;
            background: rgba(21, 44, 81, 0.79);
            border-radius: 4px;
            border: 1px solid #E2E8F0;
            color: white;
            padding: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }

        .uav-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
            font-weight: bold;
            font-size: 14px;
            color: #ffffff;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 10px;
        }

        .uav-form-group {
            margin-bottom: 12px;
        }

        .uav-label {
            font-size: 12px;
            color: #aebfd4;
            margin-bottom: 6px;
            display: block;
        }

        .uav-select {
            width: 100%;
            background: rgba(0,0,0,0.2);
            border: 1px solid #5c6f8a;
            color: white;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            outline: none;
        }

        .uav-btn {
            width: 100%;
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background 0.2s;
        }
        .recommend-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            font-weight: bold;
            display: inline-block;
        }
        .rec-safety { background: rgba(16, 185, 129, 0.2); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.4); }
        .rec-cost { background: rgba(245, 158, 11, 0.2); color: #fbbf24; border: 1px solid rgba(245, 158, 11, 0.4); }
        .rec-time { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.4); }

        /* UAV List Styles */
        .uav-list-container {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #5c6f8a;
            border-radius: 4px;
            background: rgba(0,0,0,0.2);
        }

        .uav-list-container::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .uav-list-container::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
            border-radius: 4px;
        }
        .uav-list-container::-webkit-scrollbar-thumb {
            background: #5c6f8a;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .uav-list-container { scrollbar-color: #5c6f8a transparent; scrollbar-width: thin; }

        .uav-group-title {
            padding: 4px 8px;
            font-size: 11px;
            background: #4a5b73;
            color: #cbd5e1;
            font-weight: bold;
            position: sticky;
            top: 0;
        }

        .uav-option {
            padding: 8px;
            font-size: 12px;
            color: white;
            cursor: pointer;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .uav-option-content {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .uav-icon {
            width: 24px;
            height: 24px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #aebfd4;
            transition: all 0.2s;
        }

        .uav-option:hover .uav-icon {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        /* UAV Detail Modal */
        .uav-detail-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 8px;
            z-index: 2000;
            display: none;
            flex-direction: column;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
        }

        .plan-detail-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 640px;
            max-height: 80vh;
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 8px;
            z-index: 2100;
            display: none;
            flex-direction: column;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
        }
        .plan-detail-header {
            padding: 12px 16px;
            background: #334155;
            border-bottom: 1px solid #475569;
            font-weight: bold;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .plan-detail-body {
            padding: 16px;
            font-size: 13px;
            color: #e2e8f0;
            overflow-y: auto;
        }
        .gantt-container {
            margin-top: 8px;
            border: 1px solid #475569;
            border-radius: 4px;
            padding: 10px;
            background: rgba(0,0,0,0.2);
        }
        .gantt-row {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 10px;
            align-items: center;
            margin-bottom: 8px;
        }
        .gantt-label {
            color: #94a3b8;
            font-size: 12px;
        }
        .gantt-bar {
            height: 16px;
            border-radius: 4px;
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
        }
        .gantt-bar.orange { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .gantt-bar.green { background: linear-gradient(90deg, #10b981, #34d399); }
        .gantt-legend {
            display: flex;
            gap: 10px;
            font-size: 11px;
            color: #94a3b8;
            margin-top: 6px;
        }
        .intent-list { display: flex; flex-direction: column; gap: 6px; margin-top: 6px; }
        .intent-item { display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.2); border: 1px solid #475569; border-radius: 6px; padding: 6px 8px; }
        .intent-left { display: flex; align-items: center; gap: 8px; color: #cbd5e1; font-size: 12px; }
        .intent-badge { font-size: 12px; font-weight: bold; padding: 2px 8px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.2); }
        .intent-badge.green { background: rgba(16,185,129,0.2); color: #10b981; border-color: rgba(16,185,129,0.4); }
        .intent-badge.yellow { background: rgba(245,158,11,0.2); color: #f59e0b; border-color: rgba(245,158,11,0.4); }
        .intent-badge.slate { background: rgba(148,163,184,0.2); color: #94a3b8; border-color: rgba(148,163,184,0.4); }
        .intent-progress { height: 6px; background: rgba(255,255,255,0.08); border: 1px solid #475569; border-radius: 4px; overflow: hidden; }
        .intent-progress-fill { height: 100%; }
        .intent-progress-fill.fill-70 { width: 70%; background: linear-gradient(90deg, #10b981, #34d399); }
        .intent-progress-fill.fill-60 { width: 60%; background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .intent-progress-fill.fill-50 { width: 50%; background: linear-gradient(90deg, #3b82f6, #60a5fa); }
        .gantt-steps { display: flex; gap: 2px; height: 16px; }
        .gantt-step { height: 16px; border-radius: 4px; }
        .gantt-step.green { background: linear-gradient(90deg, #10b981, #34d399); }
        .gantt-step.orange { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .gantt-step.blue { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
        .sim-track { position: relative; height: 12px; background: rgba(255,255,255,0.08); border: 1px solid #475569; border-radius: 6px; display: flex; overflow: hidden; }
        .sim-segment { height: 100%; }
        .sim-segment.green { background: linear-gradient(90deg, #10b981, #34d399); }
        .sim-segment.orange { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .sim-segment.blue { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
        .sim-segment.active { filter: brightness(1.25); }
        .sim-dot { position: absolute; top: -4px; width: 8px; height: 8px; background: #ffffff; border-radius: 50%; box-shadow: 0 0 8px rgba(255,255,255,0.9); animation-name: simMove; animation-timing-function: linear; animation-fill-mode: forwards; }
        @keyframes simMove { from { left: 0%; } to { left: 100%; } }
        .gantt-axis { position: relative; height: 20px; margin-bottom: 8px; }
        .gantt-axis-tick { position: absolute; top: 0; transform: translateX(-50%); font-size: 10px; color: #94a3b8; border-left: 1px dashed #475569; height: 100%; padding-left: 2px; }
        .gantt-stage-wrap { position: relative; height: 16px; background: rgba(255,255,255,0.06); border: 1px solid #475569; border-radius: 4px; }
        .gantt-stage-bar { position: absolute; height: 100%; background: rgba(59,130,246,0.25); border: 1px solid #3b82f6; border-radius: 4px; display: flex; gap: 2px; padding: 0 2px; box-sizing: border-box; }
        .sim-map-wrap { position: relative; height: 220px; border: 1px solid #475569; border-radius: 6px; overflow: hidden; }
        .sim-map-wrap iframe { width: 100%; height: 100%; border: 0; }
        .sim-route-dot { position: absolute; top: 50%; width: 10px; height: 10px; background: #10b981; border-radius: 50%; box-shadow: 0 0 8px rgba(16,185,129,0.9); transform: translateY(-50%); left: 10%; animation-timing-function: linear; animation-fill-mode: forwards; }
        .sim-label { position: absolute; top: calc(50% + 10px); transform: translateX(-50%); font-size: 10px; color: #cbd5e1; background: rgba(0,0,0,0.4); padding: 2px 4px; border-radius: 3px; }
        @keyframes routeMove { from { left: 10%; } to { left: 80%; } }

        .uav-detail-header {
            padding: 12px 16px;
            background: #334155;
            border-bottom: 1px solid #475569;
            font-weight: bold;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .uav-detail-body {
            padding: 16px;
            color: #cbd5e1;
            font-size: 13px;
        }

        .uav-spec-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            border-bottom: 1px dashed #475569;
            padding-bottom: 4px;
        }
        .uav-spec-row:last-child { border-bottom: none; }
        
        .uav-spec-label { color: #94a3b8; }
        .uav-spec-val { color: white; font-weight: bold; }

        .overlay-backdrop {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
            display: none;
        }

        .uav-option.selected {
            background: rgba(59, 130, 246, 0.3);
            border-left: 3px solid #3b82f6;
        }

        .uav-option.in-mission {
            background: rgba(245, 158, 11, 0.18);
            border-left: 3px solid #f59e0b;
        }

        .uav-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(0,0,0,0.1);
        }

        /* Custom Scrollbar for UAV List */
        .uav-list-container::-webkit-scrollbar {
            width: 4px;
        }
        .uav-list-container::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
        }
        .uav-list-container::-webkit-scrollbar-thumb {
            background: #5c6f8a;
            border-radius: 2px;
        }

        .monitor-header {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: #4a5b73; /* Lighter header */
            border-bottom: 1px solid #5c6f8a;
            flex-shrink: 0;
            height: 40px;
        }

        .monitor-header .icon-circle {
            width: 24px;
            height: 24px;
            background: #7c92ac;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            border: 1px solid #aebfd4;
        }
        
        .monitor-header .icon-circle i {
            font-size: 12px !important;
        }

        .monitor-header span {
            font-size: 14px;
            letter-spacing: 1px;
            font-weight: bold;
        }

        .monitor-body {
            padding: 8px;
            background: transparent;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow: hidden;
        }

        .info-box {
            border: 1px solid #aebfd4;
            border-radius: 4px;
            padding: 8px;
            position: relative;
            background: transparent;
            flex-shrink: 0;
        }

        .detail-link {
            position: absolute;
            top: 8px;
            right: 8px;
            color: #3b82f6;
            text-decoration: none;
            font-size: 12px;
        }

        .info-row {
            margin-bottom: 4px;
            display: flex;
            font-size: 12px;
            align-items: center;
            line-height: 1.3;
        }

        .info-row:last-child {
            margin-bottom: 0;
        }

        .info-label {
            color: #aebfd4;
            width: 65px;
            flex-shrink: 0;
        }

        .info-value {
            color: #ffffff;
            white-space: normal;
            word-break: break-word;
        }

        .badge-green {
            background: #10b981;
            color: white;
            padding: 2px 8px;
            border-radius: 2px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            white-space: nowrap;
            width: fit-content;
        }

        .feed-container {
            position: relative;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #5c6f8a;
            flex: 1;
            width: 100%;
        }

        .feed-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        /* Intel Popup Toast */
        .intel-popup {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(-50px);
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid #3b82f6;
            color: white;
            padding: 12px 20px;
            border-radius: 4px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            z-index: 3000;
            display: flex;
            align-items: center;
            gap: 15px;
            opacity: 0;
            pointer-events: none;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }

        .intel-popup.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
            pointer-events: auto;
        }

        .popup-icon-box {
            width: 36px;
            height: 36px;
            background: rgba(59, 130, 246, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #3b82f6;
            flex-shrink: 0;
        }

        .popup-content h4 {
            margin: 0 0 4px 0;
            font-size: 14px;
            color: #ffffff;
        }
        
        .popup-content p {
            margin: 0;
            font-size: 12px;
            color: #cbd5e1;
        }

        .popup-close {
            color: #64748b;
            cursor: pointer;
            padding: 4px;
        }
        .popup-close:hover { color: white; }
       
        .slide-in-right {
            animation: slideInRight 0.5s ease-out forwards;
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 3000; }
        .modal-container { width: 1140px; max-width: 95vw; max-height: 88vh; background: #1e293b; border: 1px solid #475569; border-radius: 8px; color: #e2e8f0; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5); display: flex; flex-direction: column; }
        .modal-header { padding: 12px 16px; border-bottom: 1px solid #475569; }
        .modal-header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .modal-title { display: flex; align-items: center; gap: 8px; font-weight: bold; color: #ffffff; }
        .modal-close { background: transparent; border: none; color: #94a3b8; font-size: 20px; cursor: pointer; }
        .modal-close:hover { color: #fff; }
        .modal-tabs { display: flex; gap: 10px; }
        .tab-item { padding: 6px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; color: #cbd5e1; border: 1px solid transparent; }
        .tab-item.active { background: rgba(59,130,246,0.15); border-color: #3b82f6; color: #fff; }
        .modal-body { padding: 16px; display: block; }
        .detail-section { background: rgba(255,255,255,0.05); border: 1px solid #475569; border-radius: 6px; padding: 12px; }
        .tab-content { display: none; }
        .tab-content.active { display: grid; grid-template-columns: minmax(420px, 500px) 1.6fr; gap: 14px; }
        .tab-content .info-row { display: grid; grid-template-columns: 100px 1fr; gap: 6px; align-items: start; margin-bottom: 8px; }
        .info-label { color: #94a3b8; font-size: 12px; }
        .info-value { color: #e2e8f0; font-size: 12px; }
        .badge-orange { background: rgba(245,158,11,0.2); color: #f59e0b; border: 1px solid rgba(245,158,11,0.4); padding: 2px 6px; border-radius: 4px; }
        .badge-red { background: rgba(239,68,68,0.2); color: #ef4444; border: 1px solid rgba(239,68,68,0.4); padding: 2px 6px; border-radius: 4px; }
        .highlight { color: #3b82f6; font-weight: bold; }
        .tag-list { display: flex; gap: 6px; flex-wrap: wrap; }
        .badge-new-text { background: rgba(59,130,246,0.15); color: #60a5fa; border: 1px solid rgba(59,130,246,0.4); border-radius: 4px; padding: 2px 6px; font-size: 12px; }
        .tag-cat { padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .green-tag { background: rgba(16,185,129,0.2); color: #10b981; border: 1px solid rgba(16,185,129,0.4); }
        .purple-tag { background: rgba(167,139,250,0.2); color: #a78bfa; border: 1px solid rgba(167,139,250,0.4); }
        .media-gallery { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .media-item img { width: 100%; height: 100px; object-fit: cover; border-radius: 4px; border: 1px solid #475569; }
        .map-placeholder { position: relative; height: 460px; border-radius: 6px; overflow: hidden; }
        .map-controls-group { position: absolute; top: 10px; left: 10px; display: flex; gap: 8px; z-index: 10; }
        .map-btn-toggle { background: rgba(0,0,0,0.4); color: #fff; border: 1px solid #475569; border-radius: 4px; font-size: 12px; padding: 4px 8px; cursor: pointer; }
        .map-btn-toggle.active { background: rgba(59,130,246,0.7); border-color: #3b82f6; }
        #modal-info-summary { white-space: normal; word-break: break-word; }
        #intelGallery { -ms-overflow-style: none; scrollbar-width: none; }
        #intelGallery::-webkit-scrollbar { display: none; }
        .trace-network { position: relative; display: grid; grid-template-columns: minmax(320px, 380px) 1fr minmax(320px, 380px); gap: 12px; min-height: 420px; }
        .connector-svg { position: absolute; inset: 0; pointer-events: none; }
        .path-line { stroke: rgba(148,163,184,0.4); stroke-width: 2; fill: none; }
        .trace-col { background: rgba(255,255,255,0.05); border: 1px solid #475569; border-radius: 6px; padding: 12px; }
        .col-header-trace { font-weight: bold; color: #3b82f6; margin-bottom: 8px; }
        .trace-raw-list { display: flex; flex-direction: column; gap: 8px; }
        .trace-raw-item { display: flex; align-items: center; justify-content: space-between; font-size: 12px; color: #e2e8f0; background: rgba(0,0,0,0.2); border: 1px solid #475569; border-radius: 4px; padding: 6px 8px; }
        .raw-tag { font-size: 11px; color: #94a3b8; background: rgba(148,163,184,0.15); border: 1px solid rgba(148,163,184,0.3); border-radius: 4px; padding: 2px 6px; }
        .blue-icon { color: #60a5fa; }
        .green-icon { color: #10b981; }
        .orange-icon { color: #f59e0b; }
        .purple-icon { color: #a78bfa; }
        .trace-panel { display: flex; flex-direction: column; gap: 12px; }
        .evidence-grid { display: grid; grid-template-columns: 1fr; gap: 8px; }
        .trace-card { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.05); border: 1px solid #475569; border-radius: 6px; padding: 10px; }
        .trace-card.small-card { padding: 8px; }
        .t-icon { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: rgba(148,163,184,0.15); color: #e2e8f0; flex-shrink: 0; }
        .icon-sat { color: #60a5fa; background: rgba(59,130,246,0.2); }
        .icon-sig { color: #10b981; background: rgba(16,185,129,0.2); }
        .icon-web { color: #f59e0b; background: rgba(245,158,11,0.2); }
        .icon-hum { color: #a78bfa; background: rgba(167,139,250,0.2); }
        .icon-fusion { color: #3b82f6; background: rgba(59,130,246,0.25); }
        .t-content .t-title { font-weight: bold; color: #e2e8f0; font-size: 13px; }
        .t-content .t-desc { color: #94a3b8; font-size: 12px; }
        .fusion-card { position: relative; display: flex; flex-direction: column; gap: 10px; align-items: flex-start; background: rgba(30,41,59,0.8); border: 1px solid #3b82f6; padding: 14px; border-radius: 8px; }
        .fusion-dot-right { position: absolute; right: -6px; top: 50%; width: 12px; height: 12px; background: #3b82f6; border-radius: 50%; transform: translateY(-50%); box-shadow: 0 0 10px rgba(59,130,246,0.6); }
        .fusion-stats { display: flex; gap: 12px; color: #cbd5e1; font-size: 12px; }
        .stat-item .stat-val { color: #3b82f6; font-weight: bold; margin-right: 4px; }
        .result-card-full { display: flex; flex-direction: column; gap: 10px; background: rgba(255,255,255,0.05); border: 1px solid #475569; border-radius: 8px; padding: 12px; }
        .result-header { display: flex; justify-content: space-between; align-items: center; }
        .result-tag { background: rgba(239,68,68,0.2); color: #ef4444; border: 1px solid rgba(239,68,68,0.4); padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .result-body { display: flex; flex-direction: column; gap: 8px; color: #e2e8f0; }
        .result-title { margin: 0; font-size: 16px; color: #ffffff; }
        .result-meta { display: flex; gap: 12px; font-size: 12px; color: #94a3b8; }
        .result-desc { font-size: 12px; color: #cbd5e1; line-height: 1.6; }
        .result-actions { display: flex; justify-content: flex-start; }
        .btn-report { background: #3b82f6; color: white; border: 1px solid #60a5fa; border-radius: 4px; padding: 6px 10px; font-size: 12px; cursor: pointer; }
        .btn-report:hover { background: #2563eb; }
        .reasoning-layout { display: grid; grid-template-columns: 360px 1fr 360px; gap: 16px; min-height: 420px; }
        .reason-step { background: rgba(255,255,255,0.05); border: 1px solid #475569; border-radius: 6px; padding: 12px; }
        .step-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .step-badge { background: rgba(59,130,246,0.15); color: #60a5fa; border: 1px solid rgba(59,130,246,0.4); padding: 2px 6px; border-radius: 4px; font-size: 12px; }
        .step-badge-sm { background: rgba(59,130,246,0.15); color: #60a5fa; border: 1px solid rgba(59,130,246,0.4); padding: 1px 6px; border-radius: 4px; font-size: 11px; margin-right: 6px; }
        .step-card { display: flex; gap: 10px; align-items: center; background: rgba(0,0,0,0.2); border: 1px solid #475569; border-radius: 6px; padding: 10px; margin-bottom: 8px; }
        .ai-card { background: rgba(59,130,246,0.15); border-color: #3b82f6; }
        .card-icon { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: rgba(59,130,246,0.2); color: #60a5fa; }
        .card-content h4 { margin: 0; font-size: 14px; color: #e2e8f0; }
        .card-content p { margin: 0; font-size: 12px; color: #94a3b8; }
        .card-content .sub-text { margin-top: 6px; font-size: 12px; color: #60a5fa; }
        .progress-bar { width: 100%; height: 8px; background: rgba(148,163,184,0.2); border: 1px solid rgba(148,163,184,0.3); border-radius: 6px; margin: 6px 0; overflow: hidden; }
        .progress-bar .fill { height: 100%; background: #3b82f6; color: #ffffff; font-size: 10px; line-height: 8px; text-align: right; padding-right: 6px; border-radius: 6px; }
        .step-details-inline { display: flex; flex-direction: column; gap: 8px; }
        .detail-item { display: flex; gap: 8px; align-items: flex-start; }
        .d-dot { width: 8px; height: 8px; border-radius: 50%; background: #3b82f6; margin-top: 6px; }
        .d-content strong { color: #e2e8f0; font-size: 12px; }
        .d-content p { color: #94a3b8; font-size: 12px; margin: 2px 0 0; }
        .step-connector { display: flex; align-items: center; justify-content: center; color: #94a3b8; margin-top: 8px; }
        .result-card { background: rgba(239,68,68,0.12); border-color: #ef4444; }
        .prediction-list { list-style: none; padding: 0; margin: 6px 0 0; display: flex; flex-direction: column; gap: 6px; color: #e2e8f0; font-size: 12px; }
        .text-red { color: #ef4444; }
        .text-orange { color: #f59e0b; }
        .text-blue { color: #3b82f6; }
        @media (max-width: 1200px) {
            .modal-container { width: 90vw; }
            .tab-content.active { grid-template-columns: minmax(300px, 380px) 1fr; }
            .map-placeholder { height: 360px; }
            .trace-network { grid-template-columns: 1fr; }
        }
        @media (max-width: 860px) {
            .modal-body { padding: 12px; display: block; }
            .tab-content.active { display: block; }
            .media-gallery { grid-template-columns: 1fr; }
            .map-placeholder { height: 280px; }
            .trace-network { grid-template-columns: 1fr; min-height: 420px; }
        }
    </style>
</head>
<body>
    <!-- Top Bar -->
    <header class="main-header">
        <div class="brand">
            <div class="logo-icon"><img src="images/logo.png" alt="Logo" style="height: 20px;"></div> 
            <span class="brand-text"> | 多模态视觉融合应用</span>
        </div>
        <div class="user-profile">
            <div class="avatar">Z</div>
        </div>
    </header>

    <div class="sub-header">
        <div class="system-icons">

            <a href="javascript:void(0)" onclick="toggleIntelPush()" style="color: inherit; text-decoration: none; cursor: pointer;">
            <svg t="1768383451211" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8798" width="22" height="22" style="vertical-align: middle; fill: white;"><path d="M825.6 820.48a520.96 520.96 0 0 0-85.333333-54.186667 730.88 730.88 0 0 0 42.666666-232.106666h170.666667a438.186667 438.186667 0 0 1-128 286.293333z m-196.266667 115.626667a349.44 349.44 0 0 0 80.64-104.106667 444.586667 444.586667 0 0 1 59.306667 35.84 438.613333 438.613333 0 0 1-139.52 68.266667zM554.666667 902.4v-115.626667a441.173333 441.173333 0 0 1 93.013333 18.773334A206.933333 206.933333 0 0 1 554.666667 902.4z m0-368.213333h156.586666a696.746667 696.746667 0 0 1-34.986666 205.226666 512 512 0 0 0-121.6-24.746666z m0-224.426667a506.026667 506.026667 0 0 0 121.6-24.746667 674.986667 674.986667 0 0 1 33.706666 177.493334H554.666667z m0-187.733333a206.933333 206.933333 0 0 1 93.013333 96.426666 439.893333 439.893333 0 0 1-93.013333 18.773334z m217.6 34.56a438.186667 438.186667 0 0 1-59.306667 35.84 350.72 350.72 0 0 0-80.64-104.106667 436.48 436.48 0 0 1 138.24 67.84z m178.773333 305.92h-170.666667a721.066667 721.066667 0 0 0-42.666666-203.946667 512 512 0 0 0 85.333333-54.186667 438.186667 438.186667 0 0 1 126.293333 257.706667z m-469.333333-224a437.76 437.76 0 0 1-102.826667-19.626667 194.986667 194.986667 0 0 1 102.826667-100.266667z m0 224h-166.4a682.666667 682.666667 0 0 1 33.706666-177.493334 512 512 0 0 0 131.84 25.6v151.893334z m0 251.733333a508.16 508.16 0 0 0-131.84 25.6 696.746667 696.746667 0 0 1-34.986667-205.226667h166.826667z m0 192a195.84 195.84 0 0 1-102.826667-100.266667 437.76 437.76 0 0 1 102.826667-19.626666z m-227.413334-37.973333H256a438.186667 438.186667 0 0 1 59.306667-35.84 350.72 350.72 0 0 0 80.64 104.106666 436.48 436.48 0 0 1-142.506667-68.693333zM72.533333 534.186667h170.666667a733.44 733.44 0 0 0 42.666667 232.106666 512 512 0 0 0-85.333334 54.186667 438.186667 438.186667 0 0 1-128-286.293333z m125.866667-330.666667A520.96 520.96 0 0 0 284.586667 256a721.066667 721.066667 0 0 0-42.666667 203.946667h-170.666667a438.186667 438.186667 0 0 1 127.146667-256.426667z m196.266667-115.626667A349.44 349.44 0 0 0 314.026667 192 444.586667 444.586667 0 0 1 256 156.16a438.613333 438.613333 0 0 1 138.24-68.266667zM512 0a512 512 0 1 0 512 512A512 512 0 0 0 512 0z" fill="white" p-id="8799"></path></svg>
            </a>
            <a href="javascript:void(0)" onclick="toggleMonitor()" style="color: inherit; text-decoration: none; cursor: pointer;"><i class="fa-solid fa-video" style="color: white;"></i></a>
            <a href="javascript:void(0)" onclick="toggleUavDispatch()" style="color: inherit; text-decoration: none; cursor: pointer;">
            <svg t="1768383611280" class="icon" viewBox="0 0 2048 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11272" width="35" height="25" style="vertical-align: middle; fill: white;"><path d="M1463.217231 276.637538c-4.883692 4.844308-12.209231 4.844308-17.132308 4.844308-9.806769 0-17.132308-4.844308-24.457846-12.130461l-36.706462-48.521847c-9.806769-12.130462-7.325538-31.547077 7.325539-41.275076a28.987077 28.987077 0 0 1 41.629538 7.286153l36.706462 48.561231c9.728 14.572308 7.325538 31.507692-7.364923 41.235692z m-97.870769 0c-4.883692 4.844308-12.209231 4.844308-17.132308 4.844308-9.806769 0-17.132308-4.844308-24.457846-12.130461l-36.706462-48.521847c-9.846154-12.130462-7.325538-31.547077 7.325539-41.275076a28.987077 28.987077 0 0 1 41.590154 7.286153l36.706461 48.561231c9.767385 14.572308 7.325538 31.507692-7.364923 41.235692z m-105.235693 0c-4.883692 4.844308-12.209231 4.844308-17.092923 4.844308-9.806769 0-17.132308-4.844308-24.497231-12.130461l-36.667077-48.521847c-9.806769-12.130462-7.364923-31.547077 7.325539-41.275076a28.987077 28.987077 0 0 1 41.590154 7.286153l36.706461 48.561231c9.767385 14.572308 7.325538 31.507692-7.364923 41.235692z m-237.331692 524.169847a54.075077 54.075077 0 0 1-53.838769-53.405539c0-29.144615 24.497231-53.366154 53.838769-53.366154s53.799385 24.260923 53.799385 53.366154c2.481231 29.144615-21.976615 53.405538-53.799385 53.405539zM805.021538 281.481846c-4.883692 0-12.209231-2.402462-17.132307-4.844308-12.209231-9.688615-14.651077-26.702769-7.286154-41.235692l36.706461-48.561231c9.767385-12.130462 26.899692-14.572308 41.590154-7.286153 12.209231 9.728 14.651077 26.702769 7.325539 41.275076l-36.706462 48.521847a29.932308 29.932308 0 0 1-24.457846 12.130461z m-46.473846-60.652308l-36.667077 48.521847c-4.923077 7.286154-14.690462 12.130462-24.49723 12.130461a45.686154 45.686154 0 0 1-17.132308-4.844308c-12.209231-9.688615-14.690462-26.702769-7.325539-41.235692l36.706462-48.561231c9.767385-12.130462 26.899692-14.572308 41.550769-7.286153 14.729846 9.728 17.171692 29.144615 7.364923 41.275076z m308.342154 303.340308h17.092923v101.888h-122.328615V524.209231h105.235692zM660.637538 220.829538l-36.706461 48.521847c-4.883692 7.286154-14.651077 12.130462-24.418462 12.130461a45.686154 45.686154 0 0 1-17.171692-4.844308c-12.209231-9.688615-14.690462-26.702769-7.325538-41.235692l36.706461-48.561231c9.767385-12.130462 26.899692-14.572308 41.550769-7.286153 14.729846 9.728 17.171692 29.144615 7.364923 41.275076zM2006.409846 7.286154h-225.083077c-22.055385 0-41.590154 19.416615-41.590154 41.235692 0 21.858462 19.574154 41.275077 41.590154 41.275077h83.140923v80.068923h-141.863384L1235.652923 9.688615C1218.520615 4.844308 1198.946462 0 1179.332923 0h-308.263385c-19.574154 0-39.148308 2.441846-56.280615 9.688615L327.876923 169.865846H183.532308V89.796923h83.180307c22.016 0 41.590154-19.416615 41.590154-41.275077 0-21.819077-19.574154-41.235692-41.590154-41.235692H41.590154C19.574154 7.286154 0 26.702769 0 48.521846 0 70.380308 19.574154 89.796923 41.590154 89.796923h83.180308v80.068923h-22.055385c-31.744 0-58.683077 26.702769-58.683077 58.249846V271.753846c0 38.833231 31.822769 70.380308 70.931692 70.380308h342.567385V948.775385c0 21.858462 17.171692 38.833231 39.187692 38.83323h24.457846c7.364923 0 12.209231-4.844308 12.209231-12.130461L575.015385 342.173538h48.915692c26.939077 0 51.396923 16.935385 61.203692 41.235693 9.767385 24.260923 34.264615 41.235692 61.164308 41.235692h80.738461v38.833231c0 31.547077 26.899692 58.249846 58.683077 58.249846h17.171693v101.927385h-24.457846a27.057231 27.057231 0 0 0-26.939077 26.702769v177.112615c0 14.572308 12.248615 26.702769 26.939077 26.702769l291.170461 21.858462c14.690462 0 24.457846-17.014154 24.457846-31.547077v-191.724308c0-14.572308-12.209231-26.702769-26.939077-26.702769h-24.457846V524.209231H1174.449231c2.481231 0 2.481231 0 4.923077-2.441846 2.481231 0 4.923077 0 7.325538-2.441847 2.481231 0 2.481231-2.402462 4.883692-2.402461 2.481231 0 2.481231-2.441846 4.923077-2.441846 2.441846-2.402462 4.923077-2.402462 4.923077-4.844308l2.402462-2.441846c2.481231-2.402462 2.481231-4.844308 4.923077-4.844308l2.402461-2.441846c2.481231-2.402462 2.481231-4.844308 4.923077-7.246769 0 0 0-2.441846 2.441846-2.441846 0-2.441846 2.481231-4.844308 2.481231-7.286154v-50.963692h80.738462c26.899692 0 51.357538-16.974769 61.124923-41.235693 9.846154-24.260923 34.264615-41.275077 61.203692-41.275077H1472.984615l39.187693 633.383385c0 7.246769 7.325538 12.130462 12.20923 12.130461h24.497231a38.518154 38.518154 0 0 0 39.148308-38.83323V349.420308h342.528c39.148308 0 70.971077-31.507692 70.971077-70.340923v-43.716923c0-12.130462-2.481231-21.819077-9.767385-31.507693-7.364923-9.728-14.690462-17.014154-24.497231-21.858461-7.325538-2.441846-14.651077-4.844308-22.055384-4.844308h-21.976616V97.083077h83.180308c22.055385 0 41.590154-19.416615 41.590154-41.275077 0-29.144615-19.534769-48.521846-41.590154-48.521846z" fill="#C2C1C1" p-id="11273"></path></svg>
            </a>
            <svg t="1768576382981" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2718" width="22" height="22" style="vertical-align: middle; fill: white;"><path d="M145.172671 855.192646h775.95031v45.253168h-775.95031v-45.253168z m521.540372-140.192596h254.409938v45.253167h-254.409938v-45.253167z m-44.521739-166.702112h298.931677v45.253168h-298.931677v-45.253168z m67.119702-166.702112h235.329193v45.253168h-235.329193v-45.246808z" p-id="2719"></path><path d="M795.927851 133.495255c-15.321839 28.557516-34.663354 62.864696-49.698981 84.158807a331.814161 331.814161 0 0 1-27.1201 37.544547l-59.91354 71.93441a577.307031 577.307031 0 0 0-61.567205 89.832149l-13.102112 23.520198a219.275925 219.275925 0 0 1-36.749515 48.770386l17.045465 187.15667c0.795031 8.70082 8.058435 14.170634 15.60805 14.170634a15.264596 15.264596 0 0 0 10.939627-4.60482c5.89595-5.89595 11.575652-10.570733 16.89918-13.954385 1.081242-0.648745 2.658584-1.004919 4.528497-1.004919 7.632298 0 19.494161 5.679702 14.386882 18.482882-3.377292 5.323528-8.052075 11.00323-13.954385 16.90554l-109.256348 109.116422-21.942857-20.49908a30.866286 30.866286 0 0 0 0-43.593143l-109.905093-109.835131a14.501366 14.501366 0 0 0-10.214559-4.242285 14.374161 14.374161 0 0 0-10.214559 4.242285l-25.530037 25.536398a58.005466 58.005466 0 0 0-16.835578 45.386733l-12.873143 69.409391a51.740621 51.740621 0 0 1-15.035627 40.641988l-0.426137 0.432497a52.650137 52.650137 0 0 1-37.264695 15.461764l-34.80964-32.437268a15.36636 15.36636 0 0 1 0-21.796571 15.36636 15.36636 0 0 1 0-21.790211l31.502311-31.508671a2.06072 2.06072 0 0 0-0.356174-3.161043 1.653665 1.653665 0 0 0-1.01128-0.292572 2.213366 2.213366 0 0 0-0.934956 0.216249l-0.50246 0.216248c-8.268323 3.816149-16.473043 7.842186-24.385193 12.230758a35.172174 35.172174 0 0 1-41.856795-6.118559c-10.863304-11.00323-12.80318-27.762484-5.825987-41.138087 4.026037-7.842186 8.122037-15.60805 11.7919-23.596522l0.572423-1.221168a2.003478 2.003478 0 0 0-0.426137-2.874832 2.175205 2.175205 0 0 0-2.734907 0.286211l-31.292422 31.356025a15.37272 15.37272 0 0 1-21.790211 0 15.37272 15.37272 0 0 1-10.863305 4.534857 15.131031 15.131031 0 0 1-10.856944-4.528497l-32.51359-34.669714c0-13.954385 5.533416-27.336348 15.391802-37.188373a53.349764 53.349764 0 0 1 37.760795-15.608049c1.367453 0 2.734907 0.069963 4.10236 0.139925 1.367453 0.146286 2.734907 0.146286 4.10236 0.146286 21.790211 0 37.970683-13.30564 60.42236-13.30564 1.361093 0 2.728547 0.069963 4.165963 0.146286 1.513739 0.139925 2.951155 0.139925 4.458534 0.139925 15.251876 0 29.924969-5.825988 40.788273-16.689292l25.822609-25.822608a14.456845 14.456845 0 0 0 0-20.499081L154.395031 423.656149a30.592795 30.592795 0 0 0-21.796571-8.993391 30.891727 30.891727 0 0 0-21.796572 8.993391l-21.217789-21.942857 109.186385-109.186385c5.902311-5.89595 11.51205-10.570733 16.905541-13.954385 2.226087-0.858634 4.242286-1.29113 6.042236-1.291131 11.51205 0 14.959304 15.538087 12.154435 20.21287-3.377292 5.323528-8.052075 11.00323-13.954385 16.89918l-0.069963 0.076323c-9.349565 9.349565-3.523578 25.313789 9.565813 26.541317l187.086709 17.261714 0.069962-0.069963a217.425093 217.425093 0 0 1 48.554137-36.61595l24.022658-13.375602a583.304745 583.304745 0 0 0 88.979876-60.994783l72.646758-60.492323a334.638112 334.638112 0 0 1 37.328298-26.973814c21.147826-15.175553 55.385043-34.523429 83.942559-49.92159 2.798509-1.507379 5.679702-2.162484 8.414609-2.162484 12.30072-0.139925 22.152745 13.312 15.461764 25.828969z" p-id="2720"></path></svg>
            
        </div>
        <div class="page-title">指挥席</div>
        <div class="alert-status">
            <span class="badge-red">一级战备等级</span>
        </div>
    </div>

    <div class="map-container">
        <!-- Leaflet Map Container -->
        <div id="map" style="width: 100%; height: 100%; background: #0f172a; z-index: 1;"></div>
        
        <!-- Overlay Monitoring Panel -->
        <div class="monitor-overlay-panel">
            <!-- Top Row: Monitor + Details -->
            <div class="monitor-top-row">
                <!-- Intel Push Card (Hidden by default) -->


            <script>
                const intelData = [
                    {
                        title: "台湾西部彰化县进入警备状态",
                        time: "2分钟前",
                        threat: "高等威胁",
                        image: "images/6.png",
                        desc: "台湾东部战区开展跨昼夜联合演训，结合 IGSO卫星拍摄影像，无侦-7 无人机拍摄视频影像及雷达探测信号，台湾西部彰化县进入警备状态。"
                    },
                    {
                        title: "日本西南岛屿军事演练，介入台海威胁加剧",
                        time: "10分钟前",
                        threat: "中等威胁",
                        image: "images/1.png",
                        desc: "日本首相高市早苗近期发表的涉台言论，日本政府在台海问题上频频发声，试图将台海问题与自身安全挂钩。日本海上自卫队还与美军频繁开展联合军演，军事力量不容忽视。"
                    }
                ];
                let currentIntelIndex = 0;

                function updateIntelDisplay() {
                    const data = intelData[currentIntelIndex];
                    document.getElementById('intelTitle').textContent = data.title;
                    document.getElementById('intelTime').textContent = data.time;
                    const imgEl = document.getElementById('intelImage');
                    const gallery = document.getElementById('intelGallery');
                    const prevBtn = document.getElementById('galleryPrevBtn');
                    const nextBtn = document.getElementById('galleryNextBtn');
                    window._galleryIndex = 0;
                    if (Array.isArray(data.images) && data.images.length > 0 && gallery) {
                        gallery.style.display = 'flex';
                        imgEl.style.display = 'none';
                        gallery.innerHTML = data.images.map(src => '<div style="min-width:100%; height:100%; scroll-snap-align:start;"><img src="images/'+src+'" style="width:100%; height:100%; object-fit:cover;"/></div>').join('');
                        if (prevBtn) prevBtn.style.display = data.images.length > 1 ? 'inline-block' : 'none';
                        if (nextBtn) nextBtn.style.display = data.images.length > 1 ? 'inline-block' : 'none';
                        if (gallery) gallery.scrollTo({ left: 0, behavior: 'auto' });
                    } else {
                        if (imgEl) { imgEl.src = data.image; imgEl.style.display = 'block'; }
                        if (gallery) { gallery.style.display = 'none'; gallery.innerHTML = ''; }
                        if (prevBtn) prevBtn.style.display = 'none';
                        if (nextBtn) nextBtn.style.display = 'none';
                    }
                    document.getElementById('intelDesc').textContent = data.desc;
                    const badge = document.getElementById('intelThreatBadge');
                    if (badge) {
                        badge.textContent = data.threat || '';
                        let bg = '#f59e0b';
                        if ((data.threat || '').includes('高')) bg = '#ef4444';
                        if ((data.threat || '').includes('低')) bg = '#10b981';
                        badge.style.backgroundColor = bg;
                    }
                    const detailLink = document.getElementById('intelDetailLink');
                    if (detailLink) detailLink.style.display = 'inline';
                }

                function galleryPrev() {
                    const gallery = document.getElementById('intelGallery');
                    const data = intelData[currentIntelIndex];
                    if (!gallery || !Array.isArray(data.images)) return;
                    window._galleryIndex = Math.max(0, (window._galleryIndex || 0) - 1);
                    const w = gallery.clientWidth;
                    gallery.scrollTo({ left: w * window._galleryIndex, behavior: 'smooth' });
                }

                function galleryNext() {
                    const gallery = document.getElementById('intelGallery');
                    const data = intelData[currentIntelIndex];
                    if (!gallery || !Array.isArray(data.images)) return;
                    window._galleryIndex = Math.min(data.images.length - 1, (window._galleryIndex || 0) + 1);
                    const w = gallery.clientWidth;
                    gallery.scrollTo({ left: w * window._galleryIndex, behavior: 'smooth' });
                }

                function nextIntel() {
                    currentIntelIndex = (currentIntelIndex + 1) % intelData.length;
                    updateIntelDisplay();
                }

                function prevIntel() {
                    currentIntelIndex = (currentIntelIndex - 1 + intelData.length) % intelData.length;
                    updateIntelDisplay();
                }
            </script>

            <div class="monitor-card" id="monitorCard">
                    <!-- Header -->
                    <div class="monitor-header">
                        <div class="icon-circle">
                             <i class="fa-solid fa-video" style="color: white; font-size: 16px;"></i>
                        </div>
                        <span style="font-weight: bold;">实时监控</span>
                    </div>

                    <!-- Content Body -->
                    <div class="monitor-body">
                        <!-- Info Box -->
                        <div class="info-box">
                             <a href="#" class="detail-link" id="toggleDetailBtn">&gt;详情</a>
                             
                             <div class="info-row">
                                 <span class="info-label">地理位置 :</span>
                                 <span class="info-value">520 复兴路 Lukang 彰化县</span>
                             </div>
                             
                             <div class="info-row">
                                 <span class="info-label"></span>
                                 <span class="info-value">24°03'32"N &nbsp; 120°26'00"E &nbsp; 地面海拔 5.68米</span>
                             </div>

                             <div class="info-row" style="margin-top: 8px;">
                                 <span class="info-label">威胁程度 :</span>
                                 <span class="badge-green">无威胁</span>
                             </div>
                        </div>

                        <!-- Image Feed -->
                        <div class="feed-container">
                            <img src="images/实时监控.png" alt="Live Feed">
                            <!-- Detection Box -->
                            <div class="detect-box"></div>
                        </div>
                    </div>
                </div>

                <!-- Expanded Detail Panel -->
                <div class="detail-panel" id="monitorDetailPanel">
                    <div class="panel-header">
                        <span>目标详细情报</span>
                        <i class="fa-solid fa-times panel-close" onclick="toggleDetails()"></i>
                    </div>
                    <div class="panel-body">
                        <div class="detail-item">
                            <span class="d-label">目标属性</span>
                            <span class="d-value">白色 · 轿车 · 丰田 Yaris<br>车牌识别: ABC-5678 (89%)</span>
                        </div>
                        <div class="detail-item">
                            <span class="d-label">移动轨迹</span>
                            <span class="d-value">10:45 进入复兴路<br>10:48 停留于便利店前 (3min)<br>10:52 往北行驶</span>
                        </div>
                        <div class="detail-item">
                            <span class="d-label">关联记录</span>
                            <span class="d-value">该车辆过去 30 天出现 5 次<br>无异常违规记录</span>
                        </div>
                         <div class="detail-item">
                            <span class="d-label">情报来源</span>
                            <span class="d-value">CAM-01 (彰化路网)</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bottom Row: UAV Dispatch -->
            
            <!-- Bottom Row: UAV Dispatch -->
            <div class="uav-card" id="uavCard" style="position: absolute; top: 280px; left: 0;">
                <div class="uav-header">
                    <svg t="1768383611280" class="icon" viewBox="0 0 2048 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11272" width="28" height="14" style="vertical-align: middle; fill: white; margin-right: 5px;"><path d="M1463.217231 276.637538c-4.883692 4.844308-12.209231 4.844308-17.132308 4.844308-9.806769 0-17.132308-4.844308-24.457846-12.130461l-36.706462-48.521847c-9.806769-12.130462-7.325538-31.547077 7.325539-41.275076a28.987077 28.987077 0 0 1 41.629538 7.286153l36.706462 48.561231c9.728 14.572308 7.325538 31.507692-7.364923 41.235692z m-97.870769 0c-4.883692 4.844308-12.209231 4.844308-17.132308 4.844308-9.806769 0-17.132308-4.844308-24.457846-12.130461l-36.706462-48.521847c-9.846154-12.130462-7.325538-31.547077 7.325539-41.275076a28.987077 28.987077 0 0 1 41.590154 7.286153l36.706461 48.561231c9.767385 14.572308 7.325538 31.507692-7.364923 41.235692z m-105.235693 0c-4.883692 4.844308-12.209231 4.844308-17.092923 4.844308-9.806769 0-17.132308-4.844308-24.497231-12.130461l-36.667077-48.521847c-9.806769-12.130462-7.364923-31.547077 7.325539-41.275076a28.987077 28.987077 0 0 1 41.590154 7.286153l36.706461 48.561231c9.767385 14.572308 7.325538 31.507692-7.364923 41.235692z m-237.331692 524.169847a54.075077 54.075077 0 0 1-53.838769-53.405539c0-29.144615 24.497231-53.366154 53.838769-53.366154s53.799385 24.260923 53.799385 53.366154c2.481231 29.144615-21.976615 53.405538-53.799385 53.405539zM805.021538 281.481846c-4.883692 0-12.209231-2.402462-17.132307-4.844308-12.209231-9.688615-14.651077-26.702769-7.286154-41.235692l36.706461-48.561231c9.767385-12.130462 26.899692-14.572308 41.590154-7.286153 12.209231 9.728 14.651077 26.702769 7.325539 41.275076l-36.706462 48.521847a29.932308 29.932308 0 0 1-24.457846 12.130461z m-46.473846-60.652308l-36.667077 48.521847c-4.923077 7.286154-14.690462 12.130462-24.49723 12.130461a45.686154 45.686154 0 0 1-17.132308-4.844308c-12.209231-9.688615-14.690462-26.702769-7.325539-41.235692l36.706462-48.561231c9.767385-12.130462 26.899692-14.572308 41.550769-7.286153 14.729846 9.728 17.171692 29.144615 7.364923 41.275076z m308.342154 303.340308h17.092923v101.888h-122.328615V524.209231h105.235692zM660.637538 220.829538l-36.706461 48.521847c-4.883692 7.286154-14.651077 12.130462-24.418462 12.130461a45.686154 45.686154 0 0 1-17.171692-4.844308c-12.209231-9.688615-14.690462-26.702769-7.325538-41.235692l36.706461-48.561231c9.767385-12.130462 26.899692-14.572308 41.550769-7.286153 14.729846 9.728 17.171692 29.144615 7.364923 41.275076zM2006.409846 7.286154h-225.083077c-22.055385 0-41.590154 19.416615-41.590154 41.235692 0 21.858462 19.574154 41.275077 41.590154 41.275077h83.140923v80.068923h-141.863384L1235.652923 9.688615C1218.520615 4.844308 1198.946462 0 1179.332923 0h-308.263385c-19.574154 0-39.148308 2.441846-56.280615 9.688615L327.876923 169.865846H183.532308V89.796923h83.180307c22.016 0 41.590154-19.416615 41.590154-41.275077 0-21.819077-19.574154-41.235692-41.590154-41.235692H41.590154C19.574154 7.286154 0 26.702769 0 48.521846 0 70.380308 19.574154 89.796923 41.590154 89.796923h83.180308v80.068923h-22.055385c-31.744 0-58.683077 26.702769-58.683077 58.249846V271.753846c0 38.833231 31.822769 70.380308 70.931692 70.380308h342.567385V948.775385c0 21.858462 17.171692 38.833231 39.187692 38.83323h24.457846c7.364923 0 12.209231-4.844308 12.209231-12.130461L575.015385 342.173538h48.915692c26.939077 0 51.396923 16.935385 61.203692 41.235693 9.767385 24.260923 34.264615 41.235692 61.164308 41.235692h80.738461v38.833231c0 31.547077 26.899692 58.249846 58.683077 58.249846h17.171693v101.927385h-24.457846a27.057231 27.057231 0 0 0-26.939077 26.702769v177.112615c0 14.572308 12.248615 26.702769 26.939077 26.702769l291.170461 21.858462c14.690462 0 24.457846-17.014154 24.457846-31.547077v-191.724308c0-14.572308-12.209231-26.702769-26.939077-26.702769h-24.457846V524.209231H1174.449231c2.481231 0 2.481231 0 4.923077-2.441846 2.481231 0 4.923077 0 7.325538-2.441847 2.481231 0 2.481231-2.402462 4.883692-2.402461 2.481231 0 2.481231-2.441846 4.923077-2.441846 2.441846-2.402462 4.923077-2.402462 4.923077-4.844308l2.402462-2.441846c2.481231-2.402462 2.481231-4.844308 4.923077-4.844308l2.402461-2.441846c2.481231-2.402462 2.481231-4.844308 4.923077-7.246769 0 0 0-2.441846 2.441846-2.441846 0-2.441846 2.481231-4.844308 2.481231-7.286154v-50.963692h80.738462c26.899692 0 51.357538-16.974769 61.124923-41.235693 9.846154-24.260923 34.264615-41.275077 61.203692-41.275077H1472.984615l39.187693 633.383385c0 7.246769 7.325538 12.130462 12.20923 12.130461h24.497231a38.518154 38.518154 0 0 0 39.148308-38.83323V349.420308h342.528c39.148308 0 70.971077-31.507692 70.971077-70.340923v-43.716923c0-12.130462-2.481231-21.819077-9.767385-31.507693-7.364923-9.728-14.690462-17.014154-24.497231-21.858461-7.325538-2.441846-14.651077-4.844308-22.055384-4.844308h-21.976616V97.083077h83.180308c22.055385 0 41.590154-19.416615 41.590154-41.275077 0-29.144615-19.534769-48.521846-41.590154-48.521846z" fill="white" p-id="11273"></path></svg>
                    无人机侦察派遣
                </div>
                <div class="uav-form-group">
                    <span class="uav-label">目标坐标</span>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="target-coords" value="24°03'32.0&quot;N, 120°26'00.0&quot;E" 
                               style="flex: 1; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 4px; font-size: 12px; border: 1px solid #5c6f8a; color: white; outline: none;">
                        <button onclick="enableMapPicking()" style="background: #475569; border: 1px solid #5c6f8a; color: white; border-radius: 4px; padding: 0 8px; cursor: pointer;">
                            <i class="fa-solid fa-location-crosshairs"></i>
                        </button>
                    </div>
                </div>
                <div class="uav-form-group">
                    <span class="uav-label">选择执行单元 (附近可用: 3)</span>
                    <div class="uav-list-container" id="uav-list">
                        <div class="uav-group-title">🟢 可调派 (Available)</div>
                        <div class="uav-option" onclick="selectUav(this, 'uav-01')" id="opt-uav-01">
                            <div class="uav-icon" onclick="event.stopPropagation(); window.open('https://mdp.mydemo.top/', '_blank')">
                                <i class="fa-solid fa-plane-up"></i>
                            </div>
                            <div class="uav-option-content">
                                <div>
                                    <span>CH-4 彩虹 (ID: 701)</span>
                                    <div class="recommend-badge rec-time" id="badge-uav-01">时间最优</div>
                                </div>
                                <span style="color: #10b981;" id="dist-uav-01">15km</span>
                            </div>
                        </div>
                        <div class="uav-option" onclick="selectUav(this, 'uav-02')" id="opt-uav-02">
                            <div class="uav-icon" onclick="showUavDetails(event, 'WL-2 翼龙', '中空长航时侦察打击一体无人机', '4000km', '20h', '480kg')">
                                <i class="fa-solid fa-jet-fighter-up"></i>
                            </div>
                            <div class="uav-option-content">
                                <div>
                                    <span>WL-2 翼龙 (ID: 702)</span>
                                    <div class="recommend-badge rec-safety" id="badge-uav-02">安全性最优</div>
                                </div>
                                <span style="color: #10b981;" id="dist-uav-02">28km</span>
                            </div>
                        </div>
                        <div class="uav-option" onclick="selectUav(this, 'uav-03')" id="opt-uav-03">
                            <div class="uav-icon" onclick="showUavDetails(event, 'BZK-005', '高空远程侦察无人机', '2400km', '40h', '150kg')">
                                <svg t="1768370965738" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7726" width="16" height="16" style="fill: currentColor;"><path d="M 970.466 321.996 l -81.1846 0.378171 l -77.5539 60.6725 s -196.433 -0.9681 -305.46 -0.446233 l 122.427 -231.786 h -68.8798 l -190.099 226.455 c -49.2448 0.1437 -55.3335 -44.2829 -138.145 -44.2829 c -173.822 0 -231.461 175.387 -74.3855 175.387 h 211.815 l 251.97 325.853 h 108.556 l -205.186 -325.853 l 250.066 -0.355478 c 29.0582 0 54.1607 -9.52978 71.4438 -26.8422 l 124.606 -159.178 Z" p-id="7727"></path></svg>
                            </div>
                            <div class="uav-option-content">
                                <div>
                                    <span>BZK-005 (ID: 705)</span>
                                    <div class="recommend-badge rec-cost" id="badge-uav-03">效费比最优</div>
                                </div>
                                <span style="color: #10b981;" id="dist-uav-03">42km</span>
                            </div>
                        </div>

                        <div class="uav-group-title">🟡 执行任务中 (On Mission)</div>
                        <div class="uav-option disabled">
                            <div class="uav-icon"><i class="fa-solid fa-plane-circle-exclamation"></i></div>
                            <div class="uav-option-content">
                                <span>TB-001 双尾蝎 (ID: 801)</span>
                                <span>任务 A-12</span>
                            </div>
                        </div>
                        <div class="uav-option disabled">
                            <div class="uav-icon"><i class="fa-solid fa-plane-circle-exclamation"></i></div>
                            <div class="uav-option-content">
                                <span>CH-5 彩虹 (ID: 803)</span>
                                <span>任务 B-09</span>
                            </div>
                        </div>

                        <div class="uav-group-title">🔴 不可用/维护 (Unavailable)</div>
                        <div class="uav-option disabled">
                            <div class="uav-icon"><i class="fa-solid fa-plane-slash"></i></div>
                            <div class="uav-option-content">
                                <span>WZ-7 翔龙 (ID: 901)</span>
                                <span>返航补给</span>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="selected-uav-id">
                </div>
                <div class="uav-form-group">
                    <span class="uav-label">任务类型</span>
                    <select class="uav-select">
                        <option>高空持续监视</option>
                        <option>低空抵近侦察</option>
                        <option>目标激光照射</option>
                    </select>
                </div>
                <div class="uav-form-group" style="display: flex; gap: 10px;">
                    <div style="flex: 1;">
                        <span class="uav-label">无人机起飞坐标</span>
                        <input type="text" id="uav-start-coords" class="uav-select" readonly placeholder="选择无人机后自动生成">
                    </div>
                    <div style="flex: 1;">
                        <span class="uav-label">无人机返航坐标</span>
                        <input type="text" id="uav-return-coords" class="uav-select" readonly placeholder="选择无人机后自动生成">
                    </div>
                </div>
                <button class="uav-btn" onclick="dispatchUav()">
                    <i class="fa-solid fa-crosshairs"></i> 立即派遣
                </button>
            </div>
        </div>

        <!-- Intel Push Card -->
        <div class="monitor-card" id="intelCard" style="display: block; background: rgba(30, 41, 59, 0.95); border: 1px solid rgba(255, 255, 255, 0.1); width: 400px; height: 480px; position: absolute; right: 20px; top: 20px; z-index: 1001;">
            <!-- Header -->
            <div class="monitor-header">
                <div class="icon-circle">
                     <svg t="1768383451211" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8798" width="12" height="12" style="vertical-align: middle; fill: white;"><path d="M825.6 820.48a520.96 520.96 0 0 0-85.333333-54.186667 730.88 730.88 0 0 0 42.666666-232.106666h170.666667a438.186667 438.186667 0 0 1-128 286.293333z m-196.266667 115.626667a349.44 349.44 0 0 0 80.64-104.106667 444.586667 444.586667 0 0 1 59.306667 35.84 438.613333 438.613333 0 0 1-139.52 68.266667zM554.666667 902.4v-115.626667a441.173333 441.173333 0 0 1 93.013333 18.773334A206.933333 206.933333 0 0 1 554.666667 902.4z m0-368.213333h156.586666a696.746667 696.746667 0 0 1-34.986666 205.226666 512 512 0 0 0-121.6-24.746666z m0-224.426667a506.026667 506.026667 0 0 0 121.6-24.746667 674.986667 674.986667 0 0 1 33.706666 177.493334H554.666667z m0-187.733333a206.933333 206.933333 0 0 1 93.013333 96.426666 439.893333 439.893333 0 0 1-93.013333 18.773334z m217.6 34.56a438.186667 438.186667 0 0 1-59.306667 35.84 350.72 350.72 0 0 0-80.64-104.106667 436.48 436.48 0 0 1 138.24 67.84z m178.773333 305.92h-170.666667a721.066667 721.066667 0 0 0-42.666666-203.946667 512 512 0 0 0 85.333333-54.186667 438.186667 438.186667 0 0 1 126.293333 257.706667z m-469.333333-224a437.76 437.76 0 0 1-102.826667-19.626667 194.986667 194.986667 0 0 1 102.826667-100.266667z m0 224h-166.4a682.666667 682.666667 0 0 1 33.706666-177.493334 512 512 0 0 0 131.84 25.6v151.893334z m0 251.733333a508.16 508.16 0 0 0-131.84 25.6 696.746667 696.746667 0 0 1-34.986667-205.226667h166.826667z m0 192a195.84 195.84 0 0 1-102.826667-100.266667 437.76 437.76 0 0 1 102.826667-19.626666z m-227.413334-37.973333H256a438.186667 438.186667 0 0 1 59.306667-35.84 350.72 350.72 0 0 0 80.64 104.106666 436.48 436.48 0 0 1-142.506667-68.693333zM72.533333 534.186667h170.666667a733.44 733.44 0 0 0 42.666667 232.106666 512 512 0 0 0-85.333334 54.186667 438.186667 438.186667 0 0 1-128-286.293333z m125.866667-330.666667A520.96 520.96 0 0 0 284.586667 256a721.066667 721.066667 0 0 0-42.666667 203.946667h-170.666667a438.186667 438.186667 0 0 1 127.146667-256.426667z m196.266667-115.626667A349.44 349.44 0 0 0 314.026667 192 444.586667 444.586667 0 0 1 256 156.16a438.613333 438.613333 0 0 1 138.24-68.266667zM512 0a512 512 0 1 0 512 512A512 512 0 0 0 512 0z" fill="white" p-id="8799"></path></svg>
                </div>
                <span style="font-weight: bold; margin-right: 8px;">情报推送</span>
                <span style="background-color: #dbeafe; color: #3b82f6; padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: bold;">2条</span>
            </div>

            <!-- Content Body -->
            <div class="monitor-body" style="padding: 15px; color: white;">
                <!-- Title & Time -->
                <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px;">
                    <h3 id="intelTitle" style="margin: 0; font-size: 18px; font-weight: 500;">台湾西部彰化县进入警备状态</h3>
                </div>

                <!-- Info Row -->
                <div style="margin-bottom: 8px; font-size: 13px; color: #94a3b8;">
                    来源： <span style="color: #e2e8f0;">情报中心推送</span>
                    <span id="intelTime" style="color: #94a3b8; font-size: 12px; margin-left: 10px;">2分钟前</span>
                </div>

                <!-- Threat Level & Navigation -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div style="font-size: 13px; color: #94a3b8; display: flex; align-items: center;">
                        威胁程度： 
                        <span id="intelThreatBadge" style="background-color: #ef4444; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-left: 5px;">高等威胁</span>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button onclick="prevIntel()" style="background: #3b82f6; border: none; color: white; width: 24px; height: 24px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center;"><i class="fa-solid fa-chevron-left"></i></button>
                        <button onclick="nextIntel()" style="background: #3b82f6; border: none; color: white; width: 24px; height: 24px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center;"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                </div>

                <!-- Image/Gallery Placeholder -->
                <div style="width: 100%; height: 160px; background-color: #334155; margin-bottom: 12px; overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center;">
                     <img id="intelImage" src="images/6.png" alt="CCTV" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                     <div id="intelGallery" style="display:none; width:100%; height:100%; overflow-x:auto; overflow-y:hidden; display:flex; gap:0; scroll-snap-type:x mandatory;">
                     </div>
                     <button id="galleryPrevBtn" onclick="galleryPrev()" style="display:none; position:absolute; left:8px; top:50%; transform:translateY(-50%); width:24px; height:24px; border:none; border-radius:4px; background:rgba(0,0,0,0.5); color:white; cursor:pointer;"><i class="fa-solid fa-chevron-left" style="font-size:12px;"></i></button>
                     <button id="galleryNextBtn" onclick="galleryNext()" style="display:none; position:absolute; right:8px; top:50%; transform:translateY(-50%); width:24px; height:24px; border:none; border-radius:4px; background:rgba(0,0,0,0.5); color:white; cursor:pointer;"><i class="fa-solid fa-chevron-right" style="font-size:12px;"></i></button>
                     <div style="display: none; color: #94a3b8; font-size: 12px; text-align: center;">
                        <i class="fa-solid fa-video-slash" style="font-size: 24px; margin-bottom: 5px;"></i><br>
                        影像加载失败
                     </div>
                     <div style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.5); color: white; padding: 2px 5px; font-size: 10px; border-radius: 2px;">
                         <span style="border: 1px solid white; padding: 0 2px; margin-right: 2px; font-size: 8px;">CCTV</span> 13
                     </div>
                     <div style="position: absolute; top: 30px; right: 10px; color: white; font-size: 10px; font-weight: bold;">
                         新闻
                     </div>
                </div>

                <!-- Description Box -->
                <div style="border: 1px solid #475569; padding: 10px; border-radius: 4px; background: rgba(15, 23, 42, 0.6); position: relative; min-height: 80px;">
                    <p id="intelDesc" style="margin: 0; font-size: 13px; line-height: 1.6; color: #e2e8f0; text-align: justify; margin-bottom: 20px;">
                        台湾东部战区开展跨昼夜联合演训，结合 IGSO卫星拍摄影像，无侦-7 无人机拍摄视频影像及雷达探测信号，台湾西部彰化县进入警备状态。
                    </p>
                    <a id="intelDetailLink" href="javascript:void(0)" onclick="openModal()" style="position: absolute; bottom: 8px; right: 10px; color: #3b82f6; text-decoration: none; font-size: 13px;">&gt;详情</a>
                </div>
            </div>
        </div>

        <!-- Solution Recommendation Card -->
        <div class="monitor-card" id="solutionCard" style="display: none; background: rgba(30, 41, 59, 0.95); border: 1px solid rgba(255, 255, 255, 0.1); width: 400px; height: 340px; position: absolute; right: 20px; top: 510px; z-index: 1001;">
            <div class="monitor-header">
                <div class="icon-circle">
                     <i class="fa-solid fa-clipboard-check" style="color: white; font-size: 12px;"></i>
                </div>
                <span style="font-weight: bold; margin-right: 8px;">方案推荐</span>
            </div>
            <div class="monitor-body" style="padding: 15px; color: white; overflow-y: auto; max-height: 400px;">
                <div style="margin-bottom: 12px;">
                    <h4 style="margin: 0 0 6px 0; color: #3b82f6; font-size: 14px; border-left: 3px solid #3b82f6; padding-left: 8px;">意图分析</h4>
                    <p style="margin: 0; font-size: 13px; color: #cbd5e1; line-height: 1.5; text-align: justify;">
                        两艘舰艇（DDG-114, T-AGS 62）正以 15 节航速向西南方向航行，意图穿越台湾海峡并进行水文数据收集与抵近侦察，试探我方海空防御反应能力。
                    </p>
                    <div class="intent-list">
                        <div class="intent-item">
                            <div class="intent-left"><i class="fa-solid fa-magnifying-glass"></i><span>意图1：进行情报侦察</span></div>
                            <div class="intent-badge green">概率 70%</div>
                        </div>
                        <div class="intent-progress"><div class="intent-progress-fill fill-70"></div></div>
                        <div class="intent-item">
                            <div class="intent-left"><i class="fa-solid fa-cloud-sun"></i><span>意图2：收集水文气象数据，为后续军事行动做准备</span></div>
                            <div class="intent-badge yellow">概率 60%</div>
                        </div>
                        <div class="intent-progress"><div class="intent-progress-fill fill-60"></div></div>
                        <div class="intent-item">
                            <div class="intent-left"><i class="fa-solid fa-bullhorn"></i><span>意图3：展示存在，进行威慑</span></div>
                            <div class="intent-badge slate">概率 50%</div>
                        </div>
                        <div class="intent-progress"><div class="intent-progress-fill fill-50"></div></div>
                    </div>
                </div>
                <div>
                    <h4 style="margin: 0 0 6px 0; color: #10b981; font-size: 14px; border-left: 3px solid #10b981; padding-left: 8px;">建议处置方案</h4>
                    <div class="uav-list-container" style="max-height: 260px; overflow-y: auto;">
                        <div class="uav-group-title">推荐方案</div>
                        <div class="uav-option" id="opt-plan-a" onclick="showTaskDetails('plan-a')">
                            <div class="uav-icon"><i class="fa-solid fa-plane-up"></i></div>
                            <div class="uav-option-content">
                                <div>
                                    <span style="font-weight: bold;">派遣CH-4彩虹无人机</span>
                                    <div class="recommend-badge rec-time">高效 · 6小时</div>
                                </div>
                                <div style="text-align: right; color: #cbd5e1; font-size: 12px;">
                                    <div>目的：全维域监视</div>
                                    <div>效费比：高</div>
                                </div>
                            </div>
                        </div>
                        <div class="uav-group-title">备选方案</div>
                        <div class="uav-option" id="opt-plan-b" onclick="showTaskDetails('plan-b')">
                            <div class="uav-icon"><i class="fa-solid fa-ship"></i></div>
                            <div class="uav-option-content">
                                <div>
                                    <span style="font-weight: bold;">派遣 052D 驱逐舰</span>
                                    <div class="recommend-badge rec-cost">稳妥 · 24小时</div>
                                </div>
                                <div style="text-align: right; color: #cbd5e1; font-size: 12px;">
                                    <div>目的：警告驱离</div>
                                    <div>效费比：中</div>
                                </div>
                            </div>
                        </div>
                        <div class="uav-option" id="opt-plan-c" onclick="showTaskDetails('plan-c')">
                            <div class="uav-icon"><i class="fa-solid fa-satellite"></i></div>
                            <div class="uav-option-content">
                                <div>
                                    <span style="font-weight: bold;">继续观察，加强卫星监测</span>
                                    <div class="recommend-badge" style="background: rgba(239,68,68,0.2); color: #ef4444; border: 1px solid rgba(239,68,68,0.4);">推荐度：低</div>
                                </div>
                                <div style="text-align: right; color: #cbd5e1; font-size: 12px;">
                                    <div>理由：风险较高</div>
                                    <div>可能丢失目标细节</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    
    <div id="overlay-backdrop" class="overlay-backdrop" onclick="closeUavDetails()"></div>

    <div id="uav-detail-modal" class="uav-detail-modal">
        <div class="uav-detail-header">
            <span id="uav-detail-title">UAV Model</span>
            <i class="fa-solid fa-times" style="cursor:pointer;" onclick="closeUavDetails()"></i>
        </div>
        <div class="uav-detail-body">
            <div class="uav-spec-row">
                <span class="uav-spec-label">类型</span>
                <span class="uav-spec-val" id="uav-detail-type">Type</span>
            </div>
            <div class="uav-spec-row">
                <span class="uav-spec-label">最大航程</span>
                <span class="uav-spec-val" id="uav-detail-range">0km</span>
            </div>
            <div class="uav-spec-row">
                <span class="uav-spec-label">续航时间</span>
                <span class="uav-spec-val" id="uav-detail-endurance">0h</span>
            </div>
            <div class="uav-spec-row">
                <span class="uav-spec-label">任务载荷</span>
                <span class="uav-spec-val" id="uav-detail-payload">0kg</span>
            </div>
            <div style="margin-top: 15px; font-size: 12px; color: #94a3b8; line-height: 1.4;">
                <i class="fa-solid fa-triangle-exclamation" style="color: #f59e0b; margin-right: 4px;"></i>
                该型号配备高清光电吊舱与合成孔径雷达，适合全天候侦察任务。
            </div>
        </div>
    </div>
    
    <div id="planDetailModal" class="plan-detail-modal">
        <div class="plan-detail-header">
            <span id="plan-detail-title">方案详情</span>
            <i class="fa-solid fa-times" style="cursor:pointer;" onclick="closePlanDetail()"></i>
        </div>
        <div class="plan-detail-body">
            <div style="margin-bottom: 12px;">
                <div style="font-weight: bold; color: #3b82f6; margin-bottom: 4px;">任务执行方式</div>
                <div id="plan-detail-desc" style="font-size: 13px; line-height: 1.6;">—</div>
            </div>
            <div style="margin-bottom: 12px;">
                <div style="font-weight: bold; color: #10b981; margin-bottom: 4px;">甘特图</div>
                <div class="gantt-container" id="ganttContainer"></div>
            </div>
            <div>
                <div style="font-weight: bold; color: #f59e0b; margin-bottom: 4px;">方案推演</div>
                <div id="plan-simulation" style="font-size: 13px; line-height: 1.6;">—</div>
            </div>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:8px; padding: 12px 16px; border-top: 1px solid #475569;">
            <button id="plan-confirm-btn" style="background:#10b981; color:white; border:none; padding:8px 12px; border-radius:4px; font-size:12px; cursor:pointer; display:none;" onclick="confirmPlan()">
                <i class="fa-solid fa-check"></i> 确认方案
            </button>
        </div>
    </div>

    <div id="detailModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-header-top">
                    <div class="modal-title">
                        <span class="tag-cat green-tag" id="modal-title-tag">军事行动</span>
                        <span id="modal-title-text">台湾西部彰化县进入警备状态</span>
                    </div>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-tabs">
                    <div class="tab-item active" id="tab-btn-details" onclick="switchTab('details')">关联分析</div>
                    <div class="tab-item" id="tab-btn-source" onclick="switchTab('source')">信息溯源</div>
                    <div class="tab-item" id="tab-btn-reasoning" onclick="switchTab('reasoning')">正向推理</div>
                </div>
            </div>
            <div class="modal-body">
                <div id="tab-details" class="tab-content active">
                    <div class="detail-section">
                        <div class="info-row">
                            <div class="info-label">时间范围</div>
                            <div class="info-value" id="modal-info-time">2025-11-23 06:23:38 ~ 2025-11-24 22:52:38</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">威胁等级</div>
                            <div class="info-value" id="modal-info-level"><span class="badge-orange">中等威胁</span></div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">数据统计</div>
                            <div class="info-value" id="modal-info-stats">数据总量 <span class="highlight">5612</span> 条 | 媒体总量 <span class="highlight">62</span> 个</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">情报摘要</div>
                            <div class="info-value" id="modal-info-summary">据多源情报综合分析，台湾西部彰化县地区出现异常军事调动，进入二级战备状态。监测到大量军用车辆集结，无线电通信频率激增。初步研判为针对近期海上演习的防御性部署，但不排除升级可能。建议加强该区域的持续监控，重点关注沿海雷达站及防空导弹阵地的动态。</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">关联标签</div>
                            <div class="info-value">
                                <div class="tag-list" id="modal-info-tags">
                                    <span class="badge-new-text">军事调动</span>
                                    <span class="badge-new-text">战备升级</span>
                                    <span class="badge-new-text">彰化县</span>
                                </div>
                            </div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">多媒体资料</div>
                            <div class="info-value">
                                <div class="media-gallery" id="modal-media-gallery">
                                    <div class="media-item"><img src="images/6.png" alt="现场图1"></div>
                                    <div class="media-item"><img src="images/2.png" alt="现场图2"></div>
                                    <div class="media-item"><img src="images/3.png" alt="现场图3"></div>
                                    <div class="media-item"><img src="images/4.png" alt="现场图4"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="detail-section">
                        <div class="map-placeholder">
                            <iframe id="map-frame" src="https://maps.google.com/maps?q=24.051,120.542&t=h&z=12&ie=UTF8&iwloc=&output=embed" width="100%" height="100%" style="border:0; position: absolute; top: 0; left: 0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
                            <div class="map-controls-group">
                                <button class="map-btn-toggle active" id="btn-sat" onclick="toggleLayer('sat')"><i class="fa-solid fa-satellite"></i> 卫星影像</button>
                                <button class="map-btn-toggle" id="btn-road" onclick="toggleLayer('road')"><i class="fa-solid fa-road"></i> 道路网</button>
                            </div>
                            <div id="map-info-overlay" style="position: absolute; bottom: 20px; left: 20px; background: white; color: #1e293b; padding: 10px; border-radius: 8px; font-size: 12px; opacity: 0.9; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 10;">
                                <strong>目标坐标:</strong> E 120.542, N 24.051<br>
                                <strong>覆盖范围:</strong> 50km²<br>
                                <strong>更新时间:</strong> 2025-11-23 06:30
                            </div>
                        </div>
                    </div>
                </div>
                <div id="tab-source" class="tab-content">
                    <div class="trace-network" style="grid-column: 1 / -1;">

                        <div class="trace-col col-left">
                            <div class="col-header-trace"><span class="step-badge-sm">步骤一</span><i class="fa-solid fa-satellite-dish"></i> 实时情报收集</div>
                            <div class="trace-raw-list" id="trace-raw-list">
                                <div class="trace-raw-item">
                                    <span><i class="fa-solid fa-satellite blue-icon"></i> 卫星影像_20251123_001</span>
                                    <span class="raw-tag">影像</span>
                                </div>
                                <div class="trace-raw-item">
                                    <span><i class="fa-solid fa-satellite blue-icon"></i> 卫星影像_20251123_002</span>
                                    <span class="raw-tag">影像</span>
                                </div>
                                <div class="trace-raw-item">
                                    <span><i class="fa-solid fa-wifi green-icon"></i> 信号截获_A12_0625</span>
                                    <span class="raw-tag">信号</span>
                                </div>
                                <div class="trace-raw-item">
                                    <span><i class="fa-solid fa-wifi green-icon"></i> 信号截获_B03_0628</span>
                                    <span class="raw-tag">信号</span>
                                </div>
                                <div class="trace-raw-item">
                                    <span><i class="fa-brands fa-twitter orange-icon"></i> 推特舆情_#彰化_01</span>
                                    <span class="raw-tag">开源</span>
                                </div>
                                <div class="trace-raw-item">
                                    <span><i class="fa-brands fa-facebook orange-icon"></i> 脸书讨论_现场_03</span>
                                    <span class="raw-tag">开源</span>
                                </div>
                                <div class="trace-raw-item">
                                    <span><i class="fa-solid fa-user-secret purple-icon"></i> 人工报告_007_A1</span>
                                    <span class="raw-tag">人工</span>
                                </div>
                                <div class="trace-raw-item">
                                    <span><i class="fa-solid fa-newspaper orange-icon"></i> 地方新闻_快讯_01</span>
                                    <span class="raw-tag">开源</span>
                                </div>
                                <div class="trace-raw-item">
                                    <span><i class="fa-solid fa-walkie-talkie green-icon"></i> 通话记录_加密_09</span>
                                    <span class="raw-tag">信号</span>
                                </div>
                                <div class="trace-raw-item">
                                    <span><i class="fa-solid fa-satellite blue-icon"></i> 卫星SAR影像_005</span>
                                    <span class="raw-tag">影像</span>
                                </div>
                            </div>
                        </div>
                        <div class="trace-col col-middle">
                            <div class="col-header-trace"><span class="step-badge-sm">步骤二</span><i class="fa-solid fa-microchip"></i> 融合分析处理</div>
                            <div class="trace-panel">
                                <div class="evidence-grid" id="trace-evidence-grid">
                                    <div class="trace-card small-card">
                                        <div class="t-icon icon-sat"><i class="fa-solid fa-satellite"></i></div>
                                        <div class="t-content">
                                            <div class="t-title">高分卫星 GF-7</div>
                                            <div class="t-desc">捕获彰化县沿海区域高分辨率光学影像</div>
                                        </div>
                                    </div>
                                    <div class="trace-card small-card">
                                        <div class="t-icon icon-sig"><i class="fa-solid fa-wifi"></i></div>
                                        <div class="t-content">
                                            <div class="t-title">信号监测站 A12</div>
                                            <div class="t-desc">截获加密无线电通信信号 (12.5GHz)</div>
                                        </div>
                                    </div>
                                    <div class="trace-card small-card">
                                        <div class="t-icon icon-web"><i class="fa-brands fa-twitter"></i></div>
                                        <div class="t-content">
                                            <div class="t-title">开源网络爬虫</div>
                                            <div class="t-desc">社交媒体"军车"相关讨论激增</div>
                                        </div>
                                    </div>
                                    <div class="trace-card small-card">
                                        <div class="t-icon icon-hum"><i class="fa-solid fa-user-secret"></i></div>
                                        <div class="t-content">
                                            <div class="t-title">人工情报员 007</div>
                                            <div class="t-desc">目击报告：基地警戒级别提升</div>
                                        </div>
                                    </div>
                                </div>
                                <div style="text-align: center; color: #cbd5e1; margin-bottom: 10px;">
                                    <i class="fa-solid fa-arrow-down-long" style="font-size: 24px;"></i>
                                </div>
                                <div class="trace-card fusion-card" id="trace-fusion-card">
                                    <div class="fusion-dot-right"></div>
                                    <div class="t-icon icon-fusion"><i class="fa-solid fa-brain"></i></div>
                                    <div class="t-title" style="font-size: 18px;">多模态情报融合引擎</div>
                                    <div class="t-desc">对多源异构数据进行时空对齐、交叉验证与关联分析。</div>
                                    <div class="fusion-stats">
                                        <div class="stat-item"><span class="stat-val">98%</span>置信度</div>
                                        <div class="stat-item"><span class="stat-val">4</span>数据源</div>
                                        <div class="stat-item"><span class="stat-val">12ms</span>延迟</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="trace-col col-right">
                            <div class="col-header-trace"><span class="step-badge-sm">步骤三</span><i class="fa-solid fa-file-signature"></i> 研判结论</div>
                            <div class="trace-panel">
                                <div class="result-card-full" style="border: none; box-shadow: none;" id="trace-result-card">
                                    <div class="result-header">
                                        <span class="result-tag">二级战备</span>
                                        <span style="font-size: 12px; color: #991b1b;"><i class="fa-solid fa-triangle-exclamation"></i> 高威胁</span>
                                    </div>
                                    <div class="result-body">
                                        <h4 class="result-title">台湾西部彰化县军事异常调动事件</h4>
                                        <div class="result-meta">
                                            <span><i class="fa-regular fa-clock"></i> 2025-11-23</span>
                                            <span><i class="fa-solid fa-location-dot"></i> 彰化县</span>
                                        </div>
                                        <div class="result-desc">
                                            基于卫星影像、信号截获及人工情报的综合研判，确认该区域正在进行非例行性大规模军事集结。建议立即启动针对性持续监控，并同步通报战区指挥部。
                                        </div>
                                        <div class="result-actions">
                                            <button class="btn-report">
                                                <i class="fa-solid fa-file-pdf"></i> 生成研判报告
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="tab-reasoning" class="tab-content">
                    <div class="reasoning-layout" style="grid-column: 1 / -1;">
                        <div class="reason-step">
                            <div class="step-header">
                                <span class="step-badge">阶段一</span>
                                <h3 style="margin:0; font-size: 16px; color: #ffffff;">当前态势</h3>
                            </div>
                            <div class="step-card" id="reasoning-step1-card">
                                <div class="card-icon"><i class="fa-solid fa-map-location-dot"></i></div>
                                <div class="card-content">
                                    <h4>彰化县军事异常调动</h4>
                                    <p>已确认大规模车辆集结与信号激增。</p>
                                </div>
                            </div>
                            <div class="step-details-inline" id="reasoning-step1-details">
                                <div class="detail-item">
                                    <div class="d-dot"></div>
                                    <div class="d-content">
                                        <strong>数据接入</strong>
                                        <p>接收到来自 GF-7 卫星的高分辨率影像数据 (2025-11-23 06:23:38)</p>
                                    </div>
                                </div>
                                <div class="detail-item">
                                    <div class="d-dot"></div>
                                    <div class="d-content">
                                        <strong>目标识别</strong>
                                        <p>AI 视觉模型识别出地面大量军用车辆集结，数量 > 50 辆</p>
                                    </div>
                                </div>
                                <div class="detail-item">
                                    <div class="d-dot"></div>
                                    <div class="d-content">
                                        <strong>多源验证</strong>
                                        <p>关联 A12 信号监测站截获的加密无线电通信激增，确认目标活跃度</p>
                                    </div>
                                </div>
                                <div class="detail-item">
                                    <div class="d-dot"></div>
                                    <div class="d-content">
                                        <strong>初步定性</strong>
                                        <p>根据时空吻合度，判定为非例行性军事集结事件</p>
                                    </div>
                                </div>
                            </div>
                            <div class="step-connector"><i class="fa-solid fa-arrow-right"></i></div>
                        </div>
                        <div class="reason-step">
                            <div class="step-header">
                                <span class="step-badge">阶段二</span>
                                <h3 style="margin:0; font-size: 16px; color: #ffffff;">模型推演</h3>
                            </div>
                            <div class="step-card ai-card" id="reasoning-step2-card">
                                <div class="card-icon"><i class="fa-solid fa-brain"></i></div>
                                <div class="card-content">
                                    <h4>行为模式匹配</h4>
                                    <div class="progress-bar">
                                        <div class="fill" style="width: 85%">85% 匹配度</div>
                                    </div>
                                    <p class="sub-text">匹配历史库：2023年"汉光演习"前奏模式</p>
                                </div>
                            </div>
                            <div class="step-details-inline" id="reasoning-step2-details">
                                <div class="detail-item">
                                    <div class="d-dot"></div>
                                    <div class="d-content">
                                        <strong>特征提取</strong>
                                        <p>提取关键特征：沿海区域、机械化部队、无线电静默打破</p>
                                    </div>
                                </div>
                                <div class="detail-item">
                                    <div class="d-dot"></div>
                                    <div class="d-content">
                                        <strong>历史比对</strong>
                                        <p>检索过去 5 年类似事件数据库 (共 124 起)</p>
                                    </div>
                                </div>
                                <div class="detail-item">
                                    <div class="d-dot"></div>
                                    <div class="d-content">
                                        <strong>模式匹配</strong>
                                        <p>发现与 2023 年 '汉光演习' 前奏阶段部署模式高度一致</p>
                                    </div>
                                </div>
                                <div class="detail-item">
                                    <div class="d-dot"></div>
                                    <div class="d-content">
                                        <strong>置信度计算</strong>
                                        <p>基于特征重合度计算匹配分数为 85%</p>
                                    </div>
                                </div>
                            </div>
                            <div class="step-connector"><i class="fa-solid fa-arrow-right"></i></div>
                        </div>
                        <div class="reason-step">
                            <div class="step-header">
                                <span class="step-badge">阶段三</span>
                                <h3 style="margin:0; font-size: 16px; color: #ffffff;">事态预测</h3>
                            </div>
                            <div class="step-card result-card" id="reasoning-step3-card">
                                <div class="card-icon"><i class="fa-solid fa-crosshairs"></i></div>
                                <div class="card-content">
                                    <h4>未来 24 小时预测</h4>
                                    <ul class="prediction-list">
                                        <li><i class="fa-solid fa-circle-exclamation text-red"></i> 80% 概率：展开实弹射击演练</li>
                                        <li><i class="fa-solid fa-triangle-exclamation text-orange"></i> 15% 概率：提升至一级战备</li>
                                        <li><i class="fa-solid fa-info-circle text-blue"></i> 5% 概率：解除警报恢复常态</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="step-details-inline" id="reasoning-step3-details">
                                <div class="detail-item">
                                    <div class="d-dot"></div>
                                    <div class="d-content">
                                        <strong>条令分析</strong>
                                        <p>依据敌方战术条令：集结后通常在 12-24 小时内展开实弹射击</p>
                                    </div>
                                </div>
                                <div class="detail-item">
                                    <div class="d-dot"></div>
                                    <div class="d-content">
                                        <strong>环境因子</strong>
                                        <p>气象数据分析：未来 24 小时天气晴朗，适合海空联合行动</p>
                                    </div>
                                </div>
                                <div class="detail-item">
                                    <div class="d-dot"></div>
                                    <div class="d-content">
                                        <strong>政治背景</strong>
                                        <p>结合近期外交紧张局势，提升威慑行动的可能性权重</p>
                                    </div>
                                </div>
                                <div class="detail-item">
                                    <div class="d-dot"></div>
                                    <div class="d-content">
                                        <strong>概率输出</strong>
                                        <p>推算出 80% 概率进行实弹演练，15% 概率升级为一级战备</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Intel Notification Popup -->
    <div id="intelPopup" class="intel-popup" onclick="focusOnShipIntel()" style="cursor: pointer;">
        <div class="popup-icon-box">
            <i class="fa-solid fa-bell"></i>
        </div>
        <div class="popup-content">
            <h4>情报推送提醒</h4>
            <p>系统收到 1 条新的高优先级情报，请注意查看。</p>
        </div>
        <i class="fa-solid fa-times popup-close" onclick="event.stopPropagation(); closeIntelPopup()"></i>
    </div>

    <script>
        // Global variables to store ship location for focus
        let shipFocusLat = 0;
        let shipFocusLng = 0;

        function focusOnShipIntel() {
            if (shipFocusLat !== 0 && shipFocusLng !== 0) {
                map.flyTo([shipFocusLat, shipFocusLng], 9, {
                    animate: true,
                    duration: 2
                });
                closeIntelPopup();
            }
        }

        function showTaskDetails(planId) {
            const modal = document.getElementById('planDetailModal');
            const titleEl = document.getElementById('plan-detail-title');
            const descEl = document.getElementById('plan-detail-desc');
            const simEl = document.getElementById('plan-simulation');
            const gantt = document.getElementById('ganttContainer');

            window._currentPlanId = planId;
            let plan;
            if (planId === 'plan-a') {
                plan = {
                    title: 'CH-4 彩虹无人机 · 全维域监视',
                    desc: '从最近基地起飞，巡航至目标海域上空，使用光电/红外吊舱与SAR雷达进行联合作业，按照“侦察→识别→跟踪→复核”链路闭环执行，实时回传态势数据。',
                    simulation: '预估侦察覆盖半径 50km，数据回传延迟 < 2s；若目标转向加速，改为轨迹预测并压缩航线维持持续监控。',
                    timelineStages: [
                        { label: '准备与起飞', steps: [
                            { label: '准备', hours: 0.6, color: 'green' },
                            { label: '起飞', hours: 0.4, color: 'blue' }
                        ]},
                        { label: '航渡至目标', steps: [
                            { label: '爬升', hours: 0.5, color: 'blue' },
                            { label: '巡航', hours: 1.0, color: 'blue' },
                            { label: '降至作业高度', hours: 0.5, color: 'blue' }
                        ]},
                        { label: '监视执行', steps: [
                            { label: '侦察', hours: 1.5, color: 'orange' },
                            { label: '识别', hours: 1.5, color: 'orange' },
                            { label: '跟踪', hours: 2.0, color: 'orange' },
                            { label: '复核', hours: 1.0, color: 'orange' }
                        ]},
                        { label: '返航与复盘', steps: [
                            { label: '返航', hours: 0.6, color: 'green' },
                            { label: '复盘', hours: 0.4, color: 'green' }
                        ]}
                    ]
                };
                const confirmBtn = document.getElementById('plan-confirm-btn');
                if (confirmBtn) confirmBtn.style.display = 'inline-block';
            } else if (planId === 'plan-b') {
                plan = {
                    title: '052D 驱逐舰 · 警告驱离',
                    desc: '就近驱逐舰编队出动，保持安全距离伴航，使用舰载雷达与声呐进行目标识别与跟踪，适时通过甚高频无线电发出警告并实施战术压制。',
                    simulation: '预估抵达时间 24h；若对方拒不改向，实施编队变位与声呐干扰，配合空中监视实现立体压制。',
                    timelineStages: [
                        { label: '战备与起航', steps: [
                            { label: '战备', hours: 2, color: 'green' },
                            { label: '起航', hours: 2, color: 'blue' }
                        ]},
                        { label: '航渡与会合', steps: [
                            { label: '航渡', hours: 8, color: 'blue' },
                            { label: '会合', hours: 4, color: 'blue' }
                        ]},
                        { label: '伴航与警告', steps: [
                            { label: '伴航', hours: 4, color: 'orange' },
                            { label: '警告', hours: 2, color: 'orange' }
                        ]},
                        { label: '返航与评估', steps: [
                            { label: '返航', hours: 1, color: 'green' },
                            { label: '评估', hours: 1, color: 'green' }
                        ]}
                    ]
                };
                const confirmBtn = document.getElementById('plan-confirm-btn');
                if (confirmBtn) confirmBtn.style.display = 'none';
            } else if (planId === 'plan-c') {
                plan = {
                    title: '继续观察 · 卫星监测强化',
                    desc: '通过加强IGSO与SAR卫星排班，提升区域覆盖与成像频率，定期回传监测结果并进行图像解译与目标复核。',
                    simulation: '建议维持目标区域的24h覆盖，间隔2h成像，若发现异常航迹或姿态变化，切换到高频监视模式。',
                    timelineStages: [
                        { label: '卫星排班', steps: [
                            { label: '排班配置', hours: 1, color: 'blue' },
                            { label: '覆盖评估', hours: 1, color: 'blue' }
                        ]},
                        { label: '监测执行', steps: [
                            { label: '成像', hours: 3, color: 'orange' },
                            { label: '解译', hours: 2, color: 'orange' }
                        ]},
                        { label: '复核与报告', steps: [
                            { label: '复核', hours: 1, color: 'green' },
                            { label: '报告', hours: 1, color: 'green' }
                        ]}
                    ]
                };
                const confirmBtn = document.getElementById('plan-confirm-btn');
                if (confirmBtn) confirmBtn.style.display = 'none';
            }

            titleEl.textContent = plan.title;
            descEl.textContent = plan.desc;
            gantt.innerHTML = '';
            const stages = plan.timelineStages || [];
            let cursor = 0;
            const stagesAbs = stages.map(stage => {
                const steps = stage.steps.map(st => {
                    const s = cursor;
                    const e = cursor + st.hours;
                    cursor = e;
                    return { label: st.label, start: s, end: e, color: st.color || 'blue' };
                });
                return { label: stage.label, start: steps[0].start, end: steps[steps.length - 1].end, steps };
            });
            const totalH = cursor;
            const axis = document.createElement('div');
            axis.className = 'gantt-axis';
            const tickStep = totalH <= 8 ? 1 : (totalH <= 16 ? 2 : 4);
            const base = new Date();
            for (let h = 0; h <= totalH; h += tickStep) {
                const tick = document.createElement('div');
                tick.className = 'gantt-axis-tick';
                tick.style.left = Math.round((h / totalH) * 100) + '%';
                const t = new Date(base.getTime() + h * 3600 * 1000);
                const hh = String(t.getHours()).padStart(2, '0');
                const mm = String(t.getMinutes()).padStart(2, '0');
                tick.textContent = hh + ':' + mm;
                axis.appendChild(tick);
            }
            gantt.appendChild(axis);
            stagesAbs.forEach(stage => {
                const row = document.createElement('div');
                row.className = 'gantt-row';
                const label = document.createElement('div');
                label.className = 'gantt-label';
                label.textContent = stage.label;
                const wrap = document.createElement('div');
                wrap.className = 'gantt-stage-wrap';
                const bar = document.createElement('div');
                bar.className = 'gantt-stage-bar';
                bar.style.left = Math.round((stage.start / totalH) * 100) + '%';
                bar.style.width = Math.round(((stage.end - stage.start) / totalH) * 100) + '%';
                const stageTotal = stage.end - stage.start;
                wrap.appendChild(bar);
                row.appendChild(label);
                row.appendChild(wrap);
                gantt.appendChild(row);
            });

            if (simEl._timer) { clearTimeout(simEl._timer); simEl._timer = null; }
            simEl.innerHTML = '';
            const simDesc = document.createElement('div');
            simDesc.textContent = plan.simulation;
            simDesc.style.marginBottom = '8px';
            simDesc.style.color = '#cbd5e1';
            simDesc.style.fontSize = '12px';
            const mapWrap = document.createElement('div');
            mapWrap.className = 'sim-map-wrap';
            let simStart = { lat: 24.25, lng: 118.10 };
            let simTarget = { lat: 25.260555, lng: 125.003055 };
            const iframe = document.createElement('iframe');
            iframe.src = 'https://www.google.com/maps?q=' + simTarget.lat + ',' + simTarget.lng + '&z=6&output=embed';
            mapWrap.appendChild(iframe);
            const dot = document.createElement('div');
            dot.className = 'sim-route-dot';
            dot.style.animationDuration = totalH + 's';
            dot.style.animationName = 'routeMove';
            mapWrap.appendChild(dot);
            const startLab = document.createElement('div');
            startLab.className = 'sim-label';
            startLab.style.left = '10%';
            startLab.textContent = '起飞点 (CH-4)';
            mapWrap.appendChild(startLab);
            const targetLab = document.createElement('div');
            targetLab.className = 'sim-label';
            targetLab.style.left = '80%';
            targetLab.textContent = '目标点 (25°15\'38"N, 125°00\'11"E)';
            mapWrap.appendChild(targetLab);
            const status = document.createElement('div');
            status.style.marginTop = '8px';
            status.style.fontSize = '12px';
            status.style.color = '#94a3b8';
            simEl.appendChild(simDesc);
            simEl.appendChild(mapWrap);
            simEl.appendChild(status);
            const flat = stagesAbs.flatMap(st => st.steps.map(s => ({ label: s.label, hours: (s.end - s.start) })));
            function advance(i) {
                status.textContent = '当前阶段：' + flat[i].label;
                if (i + 1 < flat.length) {
                    simEl._timer = setTimeout(() => advance(i + 1), flat[i].hours * 1000);
                }
            }
            if (flat.length > 0) advance(0);

            modal.style.display = 'flex';
        }

        function closePlanDetail() {
            document.getElementById('planDetailModal').style.display = 'none';
        }

        function openModal() {
            const data = typeof intelData !== 'undefined' ? intelData[currentIntelIndex] : null;
            if (!data) return;
            const title = data.title || '';
            let cfg;
            if (title === '台湾西部彰化县进入警备状态') {
                cfg = {
                    tagText: '军事行动',
                    tagClass: 'green-tag',
                    title: '台湾西部彰化县进入警备状态',
                    time: '2025-11-23 06:23:38 ~ 2025-11-24 22:52:38',
                    level: '<span class="badge-red">高等威胁</span>',
                    stats: '数据总量 <span class="highlight">5612</span> 条 | 媒体总量 <span class="highlight">62</span> 个',
                    summary: '据多源情报综合分析，台湾西部彰化县地区出现异常军事调动，进入二级战备状态。监测到大量军用车辆集结，无线电通信频率激增。初步研判为针对近期海上演习的防御性部署，但不排除升级可能。建议加强该区域的持续监控，重点关注沿海雷达站及防空导弹阵地的动态。',
                    tags: ['军事调动','战备升级','彰化县'],
                    images: ['1.png','2.png','3.png','4.png'],
                    mapSrc: 'https://maps.google.com/maps?q=24.051,120.542&t=h&z=12&ie=UTF8&iwloc=&output=embed',
                    coords: 'E 120.542, N 24.051'
                };
            } else if (title === '日本西南岛屿军事演练，介入台海威胁加剧') {
                cfg = {
                    tagText: '政治事件',
                    tagClass: 'purple-tag',
                    title: '日本西南岛屿军事演练，介入台海威胁加剧',
                    time: '2025-11-22 06:00:00 ~ 2025-11-24 22:52:38',
                    level: '<span class="badge-orange">中等威胁</span>',
                    stats: '数据总量 <span class="highlight">3712</span> 条 &nbsp;|&nbsp; 媒体总量 <span class="highlight">121</span> 个',
                    summary: '日本自卫队在西南诸岛海域举行大规模两栖登陆演习，美军部分舰艇参与协同。此举严重加剧台海周边紧张局势，意在展示介入能力。多源情报显示演习区域存在异常电磁信号活动。',
                    tags: ['军事演习','西南诸岛','联合行动'],
                    images: ['1.png','5.png','7.png','8.png'],
                    mapSrc: 'https://maps.google.com/maps?q=26.212,127.680&t=h&z=9&ie=UTF8&iwloc=&output=embed',
                    coords: 'E 127.680, N 26.212',
                    sourceRaw:
                        '<div class="trace-raw-item"><span><i class="fa-solid fa-satellite blue-icon"></i> WorldView-3_20251122_009</span><span class="raw-tag">影像</span></div>'+
                        '<div class="trace-raw-item"><span><i class="fa-solid fa-wifi green-icon"></i> Radar_Okinawa_Sig_04</span><span class="raw-tag">信号</span></div>'+
                        '<div class="trace-raw-item"><span><i class="fa-solid fa-newspaper orange-icon"></i> NHK_News_Flash_01</span><span class="raw-tag">开源</span></div>'+
                        '<div class="trace-raw-item"><span><i class="fa-brands fa-twitter orange-icon"></i> Twitter_Trending_#Drill</span><span class="raw-tag">开源</span></div>'+
                        '<div class="trace-raw-item"><span><i class="fa-solid fa-user-secret purple-icon"></i> HUMINT_Report_JP_02</span><span class="raw-tag">人工</span></div>'+
                        '<div class="trace-raw-item"><span><i class="fa-solid fa-wifi green-icon"></i> Sig_Intercept_Naval_09</span><span class="raw-tag">信号</span></div>',
                    sourceEvidence:
                        '<div class="trace-card small-card">'+
                            '<div class="t-icon icon-sat"><i class="fa-solid fa-satellite"></i></div>'+
                            '<div class="t-content">'+
                                '<div class="t-title">WorldView-3 高分影像</div>'+
                                '<div class="t-desc">琉球近海两栖登陆演练海滩区域清晰成像</div>'+
                            '</div>'+
                        '</div>'+
                        '<div class="trace-card small-card">'+
                            '<div class="t-icon icon-sig"><i class="fa-solid fa-wifi"></i></div>'+
                            '<div class="t-content">'+
                                '<div class="t-title">冲绳雷达站</div>'+
                                '<div class="t-desc">X波段雷达与战术电台同步活跃 (加密)</div>'+
                            '</div>'+
                        '</div>'+
                        '<div class="trace-card small-card">'+
                            '<div class="t-icon icon-web"><i class="fa-brands fa-twitter"></i></div>'+
                            '<div class="t-content">'+
                                '<div class="t-title">社交媒体趋势</div>'+
                                '<div class="t-desc">#Drill 话题在当地快速攀升</div>'+
                            '</div>'+
                        '</div>'+
                        '<div class="trace-card small-card">'+
                            '<div class="t-icon icon-hum"><i class="fa-solid fa-user-secret"></i></div>'+
                            '<div class="t-content">'+
                                '<div class="t-title">HUMINT 报告</div>'+
                                '<div class="t-desc">两栖车辆装卸频繁，海军陆战队参与</div>'+
                            '</div>'+
                        '</div>',
                    sourceFusion:
                        '<div class="fusion-dot-right"></div>'+
                        '<div class="t-icon icon-fusion"><i class="fa-solid fa-brain"></i></div>'+
                        '<div class="t-title" style="font-size: 18px;">多模态情报融合引擎</div>'+
                        '<div class="t-desc">对影像、信号与开源舆情进行时空对齐与交叉验证，识别联合登陆演练模板。</div>'+
                        '<div class="fusion-stats">'+
                            '<div class="stat-item"><span class="stat-val">94%</span>置信度</div>'+
                            '<div class="stat-item"><span class="stat-val">5</span>数据源</div>'+
                            '<div class="stat-item"><span class="stat-val">18ms</span>延迟</div>'+
                        '</div>',
                    sourceResult:
                        '<div class="result-header">'+
                            '<span class="result-tag">演练介入能力</span>'+
                            '<span style="font-size: 12px; color: #991b1b;"><i class="fa-solid fa-triangle-exclamation"></i> 中等威胁</span>'+
                        '</div>'+
                        '<div class="result-body">'+
                            '<h4 class="result-title">日本西南诸岛两栖登陆演练态势评估</h4>'+
                            '<div class="result-meta">'+
                                '<span><i class="fa-regular fa-clock"></i> 2025-11-22</span>'+
                                '<span><i class="fa-solid fa-location-dot"></i> 冲绳周边海域</span>'+
                            '</div>'+
                            '<div class="result-desc">多源融合分析表明，演练具有靠近台海方向的意图展示，存在后续持续演练与联合行动的可能，需加强预警。</div>'+
                            '<div class="result-actions">'+
                                '<button class="btn-report"><i class="fa-solid fa-file-pdf"></i> 生成研判报告</button>'+
                            '</div>'+
                        '</div>',
                    reasonStep1Card:
                        '<div class="card-icon"><i class="fa-solid fa-map-location-dot"></i></div>'+
                        '<div class="card-content">'+
                            '<h4>西南诸岛两栖登陆演练</h4>'+
                            '<p>确认多兵种联合，含海军陆战队与航空支援。</p>'+
                        '</div>',
                    reasonStep1Details:
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>演练规模</strong><p>登陆车辆与两栖装备部署完善，岸滩区域多点演练。</p></div></div>'+
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>信号活动</strong><p>战术电台与雷达同时在线，电磁频谱占用显著。</p></div></div>'+
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>协同要素</strong><p>美军舰艇参与协同，指挥链路稳定。</p></div></div>',
                    reasonStep2Card:
                        '<div class="card-icon"><i class="fa-solid fa-brain"></i></div>'+
                        '<div class="card-content">'+
                            '<h4>联合登陆演练模板匹配</h4>'+
                            '<div class="progress-bar"><div class="fill" style="width: 78%">78% 匹配度</div></div>'+
                            '<p class="sub-text">匹配历史库：2022-2024 多次西南诸岛联合演练</p>'+
                        '</div>',
                    reasonStep2Details:
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>特征提取</strong><p>岸滩集结、两栖装卸、空海协同三要素同时出现。</p></div></div>'+
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>历史比对</strong><p>检索近三年 86 起相似演练样本。</p></div></div>'+
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>模式匹配</strong><p>阶段演练节奏与既有模板高度一致。</p></div></div>'+
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>置信度计算</strong><p>加权后输出匹配分数 78%。</p></div></div>',
                    reasonStep3Card:
                        '<div class="card-icon"><i class="fa-solid fa-crosshairs"></i></div>'+
                        '<div class="card-content">'+
                            '<h4>未来 24 小时预测</h4>'+
                            '<ul class="prediction-list">'+
                                '<li><i class="fa-solid fa-circle-exclamation text-red"></i> 60% 概率：靠近台海方向的军事存在增强</li>'+
                                '<li><i class="fa-solid fa-triangle-exclamation text-orange"></i> 30% 概率：连续多日演练并扩大范围</li>'+
                                '<li><i class="fa-solid fa-info-circle text-blue"></i> 10% 概率：演练降级或结束</li>'+
                            '</ul>'+
                        '</div>',
                    reasonStep3Details:
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>条令分析</strong><p>联合演练通常在 24-72 小时内进入强化阶段。</p></div></div>'+
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>环境因子</strong><p>海况与气象良好，适合持续海空行动。</p></div></div>'+
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>政治背景</strong><p>涉台言论升温，提高威慑展示概率。</p></div></div>'+
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>概率输出</strong><p>综合输出：60/30/10 概率分布。</p></div></div>'
                };
            } else {
                return;
            }

            const overlay = document.getElementById('detailModal');
            overlay.style.display = 'flex';

            const tagEl = document.getElementById('modal-title-tag');
            if (tagEl) { tagEl.textContent = cfg.tagText; tagEl.className = 'tag-cat ' + cfg.tagClass; }
            const titleEl = document.getElementById('modal-title-text');
            if (titleEl) titleEl.textContent = cfg.title;
            const timeEl = document.getElementById('modal-info-time');
            if (timeEl) timeEl.textContent = cfg.time;
            const levelEl = document.getElementById('modal-info-level');
            if (levelEl) levelEl.innerHTML = cfg.level;
            const statsEl = document.getElementById('modal-info-stats');
            if (statsEl) statsEl.innerHTML = cfg.stats;
            const sumEl = document.getElementById('modal-info-summary');
            if (sumEl) sumEl.textContent = cfg.summary;
            const tagsEl = document.getElementById('modal-info-tags');
            if (tagsEl) tagsEl.innerHTML = (cfg.tags || []).map(t => '<span class="badge-new-text">'+t+'</span>').join('');
            const galleryEl = document.getElementById('modal-media-gallery');
            if (galleryEl) galleryEl.innerHTML = (cfg.images || []).map((n,i) => '<div class="media-item"><img src="images/'+n+'" alt="现场图'+(i+1)+'"></div>').join('');

            const frame = document.getElementById('map-frame');
            if (frame) frame.src = cfg.mapSrc;
            const infoBox = document.getElementById('map-info-overlay');
            if (infoBox) infoBox.innerHTML = '<strong>目标坐标:</strong> '+cfg.coords+'<br><strong>覆盖范围:</strong> 50km²<br><strong>更新时间:</strong> '+cfg.time.split('~')[0].trim();

            const rawList = document.getElementById('trace-raw-list');
            if (rawList && cfg.sourceRaw) rawList.innerHTML = cfg.sourceRaw;
            const evidenceGrid = document.getElementById('trace-evidence-grid');
            if (evidenceGrid && cfg.sourceEvidence) evidenceGrid.innerHTML = cfg.sourceEvidence;
            const fusionCard = document.getElementById('trace-fusion-card');
            if (fusionCard && cfg.sourceFusion) fusionCard.innerHTML = cfg.sourceFusion;
            const resultCard = document.getElementById('trace-result-card');
            if (resultCard && cfg.sourceResult) resultCard.innerHTML = cfg.sourceResult;

            const step1Card = document.getElementById('reasoning-step1-card');
            if (step1Card && cfg.reasonStep1Card) step1Card.innerHTML = cfg.reasonStep1Card;
            const step1Details = document.getElementById('reasoning-step1-details');
            if (step1Details && cfg.reasonStep1Details) step1Details.innerHTML = cfg.reasonStep1Details;
            const step2Card = document.getElementById('reasoning-step2-card');
            if (step2Card && cfg.reasonStep2Card) step2Card.innerHTML = cfg.reasonStep2Card;
            const step2Details = document.getElementById('reasoning-step2-details');
            if (step2Details && cfg.reasonStep2Details) step2Details.innerHTML = cfg.reasonStep2Details;
            const step3Card = document.getElementById('reasoning-step3-card');
            if (step3Card && cfg.reasonStep3Card) step3Card.innerHTML = cfg.reasonStep3Card;
            const step3Details = document.getElementById('reasoning-step3-details');
            if (step3Details && cfg.reasonStep3Details) step3Details.innerHTML = cfg.reasonStep3Details;
        }

        function closeModal() {
            const overlay = document.getElementById('detailModal');
            overlay.style.display = 'none';
        }

        function switchTab(tab) {
            const tabs = ['details','source','reasoning'];
            tabs.forEach(t => {
                const btn = document.getElementById('tab-btn-' + t);
                const content = document.getElementById('tab-' + t);
                if (btn) btn.classList.toggle('active', t === tab);
                if (content) content.classList.toggle('active', t === tab);
            });
        }

        function toggleLayer(layer) {
            const frame = document.getElementById('map-frame');
            const satBtn = document.getElementById('btn-sat');
            const roadBtn = document.getElementById('btn-road');
            if (frame) {
                const src = frame.src || '';
                const next = layer === 'sat' ? src.replace(/t=(h|m)/,'t=h') : src.replace(/t=(h|m)/,'t=m');
                frame.src = next;
            }
            if (layer === 'sat') {
                if (satBtn) satBtn.classList.add('active');
                if (roadBtn) roadBtn.classList.remove('active');
            } else {
                if (roadBtn) roadBtn.classList.add('active');
                if (satBtn) satBtn.classList.remove('active');
            }
        }

        function confirmPlan() {
            // Set target coords to current ship focus or default
            const targetInput = document.getElementById('target-coords');
            if (shipFocusLat && shipFocusLng) {
                targetInput.value = `${shipFocusLat.toFixed(4)}°N, ${shipFocusLng.toFixed(4)}°E`;
                // Update internal target vars if present
                if (typeof currentTargetLat !== 'undefined') {
                    currentTargetLat = shipFocusLat;
                    currentTargetLng = shipFocusLng;
                }
            }

            // Visualize target selection: marker + 15km detection circle
            if (typeof selectionLayerGroup !== 'undefined') {
                selectionLayerGroup.clearLayers();
                flightPathLayerGroup.clearLayers();
                L.marker([currentTargetLat, currentTargetLng], { icon: blueMarkerIcon }).addTo(selectionLayerGroup);
                L.circle([currentTargetLat, currentTargetLng], {
                    radius: 20000,
                    color: '#3b82f6',
                    dashArray: '10, 10',
                    fillColor: '#3b82f6',
                    fillOpacity: 0.1,
                    weight: 2
                }).addTo(selectionLayerGroup);
                if (typeof analyzeRecommendations === 'function') {
                    analyzeRecommendations(currentTargetLat, currentTargetLng);
                }
            }

            // Auto select CH-4 彩虹 (ID: 701)
            const ch4Opt = document.getElementById('opt-uav-01');
            if (ch4Opt) {
                selectUav(ch4Opt, 'uav-01');
            }

            // Mark chosen plan as selected
            if (window._currentPlanId) {
                document.querySelectorAll('#solutionCard .uav-option').forEach(opt => opt.classList.remove('selected'));
                const chosen = document.getElementById('opt-' + window._currentPlanId);
                if (chosen) chosen.classList.add('selected');
            }

            // Close modal
            closePlanDetail();
        }

        // Show Intel Popup on Load
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('intelPopup').classList.add('show');
                
                // Simulate receiving new intel
                const newIntel = {
                    title: "东部战区美国两艘舰艇过航台湾海峡",
                    time: "刚刚",
                    threat: "高等威胁",
                    image: "images/船.png",
                    desc: "东部战区卫星传回SAR影像中拍摄到两艘舰艇出现在冲绳岛附近海域25°15'38\"N 125°00'11\"E，并正在航向台湾海峡，两艘美国军舰初步识别为驱逐舰和海洋测量船。"
                };

                // Add Map Markers for the Ships (25°15'38"N 125°00'11"E)
                // Lat: 25 + 15/60 + 38/3600 = 25.2606
                // Lng: 125 + 00/60 + 11/3600 = 125.0031
                const shipLat = 25.2606;
                const shipLng = 125.0031;
                
                // Store for focus function
                shipFocusLat = shipLat;
                shipFocusLng = shipLng;

                const shipIcon = L.divIcon({
                    className: 'ship-marker',
                    html: '<div style="font-size: 24px; color: #ef4444; filter: drop-shadow(0 0 5px rgba(239, 68, 68, 0.8));"><i class="fa-solid fa-ship"></i></div>',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });

                // Ship 1
                window.ship1Marker = L.marker([shipLat, shipLng], {icon: shipIcon}).addTo(map);
                
                const labelStyle = `
                    background: rgba(15, 23, 42, 0.9);
                    border: 1px solid #3b82f6;
                    color: white;
                    padding: 8px;
                    border-radius: 4px;
                    font-size: 12px;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
                    min-width: 180px;
                `;

                ship1Marker.bindTooltip(`
                    <div style="${labelStyle}">
                        <div style="font-weight: bold; color: #3b82f6; margin-bottom: 4px; border-bottom: 1px solid rgba(59,130,246,0.3); padding-bottom: 2px;">
                            目标 A (DDG-114)
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                            <span style="color: #94a3b8;">型号:</span>
                            <span>拉尔夫·约翰逊号</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #94a3b8;">置信度:</span>
                            <span style="color: #f59e0b; font-weight: bold;">45%</span>
                        </div>
                    </div>
                `, {permanent: true, direction: 'left', opacity: 1, className: 'custom-ship-tooltip', offset: [-15, 0]}).openTooltip();
                
                // Ship 2 (Offset slightly)
                window.ship2Marker = L.marker([shipLat + 0.005, shipLng + 0.008], {icon: shipIcon}).addTo(map);
                
                ship2Marker.bindTooltip(`
                    <div style="${labelStyle}">
                         <div style="font-weight: bold; color: #3b82f6; margin-bottom: 4px; border-bottom: 1px solid rgba(59,130,246,0.3); padding-bottom: 2px;">
                            目标 B (T-AGS 62)
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                            <span style="color: #94a3b8;">型号:</span>
                            <span>鲍迪奇号勘测船</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #94a3b8;">置信度:</span>
                            <span style="color: #f59e0b; font-weight: bold;">30%</span>
                        </div>
                    </div>
                `, {permanent: true, direction: 'right', opacity: 1, className: 'custom-ship-tooltip', offset: [15, 0]}).openTooltip();

                // Add CSS for custom tooltip to remove default styles
                const style = document.createElement('style');
                style.innerHTML = `
                    .custom-ship-tooltip {
                        background: transparent !important;
                        border: none !important;
                        box-shadow: none !important;
                    }
                    .custom-ship-tooltip::before {
                        display: none !important;
                    }
                `;
                document.head.appendChild(style);

                // Fly to location to show markers
                map.flyTo([shipLat, shipLng], 9, {
                    animate: true,
                    duration: 2
                });

                // Projected Path Visualization
                // Current: 25.2606, 125.0031
                // Target: Taitung Offshore (East of Taiwan) ~22.8, 121.5
                // Path must stay east of Taiwan island to avoid land
                
                const pathPoints = [
                    [25.2606, 125.0031], // Start
                    [24.5, 123.5],       // Waypoint 1 (East of Yilan)
                    [23.5, 122.5],       // Waypoint 2 (East of Hualien)
                    [22.8, 121.5]        // End (Taitung Offshore)
                ];

                // Draw Path Line
                const pathLine = L.polyline(pathPoints, {
                    color: '#ef4444',
                    weight: 2,
                    dashArray: '10, 10',
                    opacity: 0.8
                }).addTo(map);

                // Add Arrow Heads to Path
                const arrowIcon = L.divIcon({
                    className: 'path-arrow',
                    html: '<i class="fa-solid fa-caret-down" style="color: #ef4444; font-size: 16px; transform: rotate(135deg);"></i>',
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                });
                
                L.marker([24.5, 123.5], {icon: arrowIcon}).addTo(map);
                L.marker([23.5, 122.5], {icon: arrowIcon}).addTo(map);

                window._shipVectorDeg = { dx: 24.5 - shipLat, dy: 123.5 - shipLng };

                // Add Destination Marker
                const destIcon = L.divIcon({
                    className: 'dest-marker',
                    html: '<div style="background: rgba(239, 68, 68, 0.2); border: 2px solid #ef4444; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center;"><div style="background: #ef4444; width: 8px; height: 8px; border-radius: 50%;"></div></div>',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });

                const destMarker = L.marker([22.8, 121.5], {icon: destIcon}).addTo(map);
                
                // Destination Label
                destMarker.bindTooltip(`
                    <div style="background: rgba(15, 23, 42, 0.9); border: 1px solid #ef4444; color: white; padding: 6px 10px; border-radius: 4px; font-size: 12px; text-align: center;">
                        <div style="font-weight: bold; color: #ef4444; margin-bottom: 2px;">预计目的地</div>
                        <div>台东市附近海域</div>
                        <div style="font-size: 10px; color: #94a3b8; margin-top: 2px;">ETA: 12小时后</div>
                    </div>
                `, {permanent: true, direction: 'bottom', offset: [0, 10], className: 'custom-ship-tooltip'}).openTooltip();

                // Add to data source
                intelData.unshift(newIntel);
                currentIntelIndex = 0; // Switch to newest
                
                // Update UI
                updateIntelDisplay();
                
                // Update Badge Count
                const badge = document.querySelector('#intelCard .monitor-header span:last-child');
                if(badge) badge.textContent = intelData.length + "条";

                // Show Solution Recommendation Card
                document.getElementById('solutionCard').style.display = 'flex';
                document.getElementById('solutionCard').classList.add('slide-in-right');

                // Optional: Auto hide after 8 seconds
                setTimeout(() => {
                    closeIntelPopup();
                }, 8000);
            }, 20000);
        });

        function closeIntelPopup() {
            document.getElementById('intelPopup').classList.remove('show');
        }

        function toggleMonitor() {
            const monitorCard = document.getElementById('monitorCard');
            const intelCard = document.getElementById('intelCard');
            
            // If intel card is open, close it
            if (intelCard.style.display !== 'none') {
                intelCard.style.display = 'none';
            }

            if (monitorCard.style.display === 'none') {
                monitorCard.style.display = 'flex';
            } else {
                monitorCard.style.display = 'none';
            }
        }

        function toggleIntelPush() {
            const intelCard = document.getElementById('intelCard');
            const solutionCard = document.getElementById('solutionCard');

            if (intelCard.style.display === 'none') {
                intelCard.style.display = 'block';
                if (solutionCard) solutionCard.style.display = 'flex';
            } else {
                intelCard.style.display = 'none';
                if (solutionCard) solutionCard.style.display = 'none';
            }
        }

        function toggleUavDispatch() {
            const card = document.getElementById('uavCard');
            if (card.style.display === 'none') {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        }

        const detailPanel = document.getElementById('monitorDetailPanel');
        const toggleBtn = document.getElementById('toggleDetailBtn');

        toggleBtn.addEventListener('click', (e) => {
            e.preventDefault();
            toggleDetails();
        });

        function toggleDetails() {
            if (detailPanel.style.display === 'flex') {
                detailPanel.style.display = 'none';
            } else {
                detailPanel.style.display = 'flex';
            }
        }

        // UAV Selection Logic
        function selectUav(element, id) {
            // Remove selected class from all options
            const options = document.querySelectorAll('.uav-option');
            options.forEach(opt => opt.classList.remove('selected'));
            
            // Add to clicked
            element.classList.add('selected');
            document.getElementById('selected-uav-id').value = id;

            // Update Start/Return Coords and Draw Path
            updateFlightPath(id);
            window._lastSelectedUav = id;
        }

        function updateFlightPath(uavId) {
            flightPathLayerGroup.clearLayers();
            
            const base = uavBases[uavId];
            if (!base) return;

            // Fill Inputs
            const baseCoords = `${base.lat.toFixed(4)}°N, ${base.lng.toFixed(4)}°E`;
            startCoordsInput.value = baseCoords;
            returnCoordsInput.value = baseCoords; // Assuming return to same base

            // Draw Outbound Path (Base -> Target)
            const outboundPath = [
                [base.lat, base.lng],
                [currentTargetLat, currentTargetLng]
            ];

            let points = outboundPath;
            if (Array.isArray(window._uavWaypoints) && window._uavWaypoints.length > 0) {
                points = [[base.lat, base.lng], ...window._uavWaypoints, [currentTargetLat, currentTargetLng]];
            }
            L.polyline(points, {
                color: '#10b981',
                weight: 2,
                opacity: 0.9,
                dashArray: '5, 10'
            }).addTo(flightPathLayerGroup);

            // Draw Inbound Path (Target -> Base) - Slightly offset to show distinct path if needed, 
            // but physically it's usually same. To make it visible as "Return", we can curve it or just overlay.
            // Let's use a different color or style for return to distinguish.
            const inboundPoints = [...points].reverse();
            L.polyline(inboundPoints, {
                color: '#3b82f6', // Blue for return
                weight: 2,
                opacity: 0.6,
                dashArray: '2, 8', // Different dash pattern
                offset: 5 // Polyline offset plugin needed for true offset, but standard L doesn't support.
                // Since we can't easily offset without plugin, we'll just render it. 
                // A better visual for "Round Trip" on same line is arrows.
                // However, user asked to "Show Both". 
            }).addTo(flightPathLayerGroup);

            // Add Return Marker (Same as Base for now, but explicit label)
            const returnIconHtml = `<div style="display:flex;flex-direction:column;align-items:center;">
                <div style="background:#3b82f6;width:12px;height:12px;border-radius:50%;border:2px solid white;"></div>
                <span style="background:rgba(0,0,0,0.7);color:white;padding:2px 4px;border-radius:2px;font-size:10px;margin-top:2px;white-space:nowrap;">返航点</span>
            </div>`;

            L.marker([base.lat, base.lng], {
                icon: L.divIcon({
                    className: 'return-marker',
                    html: returnIconHtml,
                    iconSize: [40, 40],
                    iconAnchor: [20, 6] // Adjust anchor to center dot
                })
            }).addTo(flightPathLayerGroup);

             // Add Start Marker Label
            const startIconHtml = `<div style="display:flex;flex-direction:column;align-items:center;">
                <span style="background:rgba(0,0,0,0.7);color:white;padding:2px 4px;border-radius:2px;font-size:10px;margin-bottom:2px;white-space:nowrap;">起飞点</span>
                <div style="background:#10b981;width:12px;height:12px;border-radius:50%;border:2px solid white;"></div>
            </div>`;

            L.marker([base.lat, base.lng], {
                icon: L.divIcon({
                    className: 'start-marker',
                    html: startIconHtml,
                    iconSize: [40, 40],
                    iconAnchor: [20, 34] // Adjust anchor so dot is at location
                })
            }).addTo(flightPathLayerGroup);
        }

        let _dispatchTimer = null;
        let _dispatchMarker = null;
        let _dispatchRangeCircle = null;
        function dispatchUav() {
            const uavId = document.getElementById('selected-uav-id').value || window._lastSelectedUav || 'uav-01';
            const base = uavBases[uavId];
            if (!base) return;
            updateFlightPath(uavId);
            if (_dispatchTimer) { clearInterval(_dispatchTimer); _dispatchTimer = null; }
            if (_dispatchMarker) { map.removeLayer(_dispatchMarker); _dispatchMarker = null; }
            if (_dispatchRangeCircle) { map.removeLayer(_dispatchRangeCircle); _dispatchRangeCircle = null; }
            const uavIconHtml = `<div style="display:flex;flex-direction:column;align-items:center;">
                <div style="background:#10b981;width:10px;height:10px;border-radius:50%;border:2px solid white;"></div>
                <span style="background:rgba(0,0,0,0.6);color:white;padding:2px 4px;border-radius:2px;font-size:10px;margin-top:2px;white-space:nowrap;">UAV</span>
            </div>`;
            _dispatchMarker = L.marker([base.lat, base.lng], { icon: L.divIcon({ className: 'uav-dispatch', html: uavIconHtml, iconSize: [28, 28], iconAnchor: [14, 6] }) });
            _dispatchMarker.addTo(map);
            _dispatchRangeCircle = L.circle([base.lat, base.lng], { radius: 20000, color: '#10b981', fillColor: '#10b981', fillOpacity: 0.08, weight: 1 });
            _dispatchRangeCircle.addTo(flightPathLayerGroup);

            // Update UAV status to "On Mission"
            const badgeEl = document.getElementById('badge-' + uavId);
            if (badgeEl) { badgeEl.textContent = '任务执行中'; badgeEl.style.background = 'rgba(245,158,11,0.2)'; badgeEl.style.color = '#f59e0b'; badgeEl.style.border = '1px solid rgba(245,158,11,0.4)'; }
            const optEl = document.getElementById('opt-' + uavId);
            if (optEl) { optEl.classList.add('in-mission'); }
            const totalMs = 30000;
            const steps = 60;
            const interval = Math.floor(totalMs / steps);
            let i = 0;
            const pathPoints = (Array.isArray(window._uavWaypoints) && window._uavWaypoints.length > 0)
                ? [[base.lat, base.lng], ...window._uavWaypoints, [currentTargetLat, currentTargetLng]]
                : [[base.lat, base.lng], [currentTargetLat, currentTargetLng]];
            function kmPerDeg(lat) { return { lat: 111.32, lon: 111.32 * Math.cos(lat * Math.PI / 180) }; }
            const segLens = [];
            let totalKm = 0;
            for (let s = 0; s < pathPoints.length - 1; s++) {
                const a = pathPoints[s], b = pathPoints[s + 1];
                const k = kmPerDeg((a[0] + b[0]) / 2);
                const dx = (b[0] - a[0]) * k.lat;
                const dy = (b[1] - a[1]) * k.lon;
                const d = Math.sqrt(dx*dx + dy*dy);
                segLens.push(d); totalKm += d;
            }
            const cum = []; let acc = 0; for (let s = 0; s < segLens.length; s++) { acc += segLens[s]; cum.push(acc); }
            function posAtRatio(r) {
                const kmPos = r * totalKm;
                let idx = cum.findIndex(v => v >= kmPos);
                if (idx === -1) idx = segLens.length - 1;
                const prevKm = idx === 0 ? 0 : cum[idx - 1];
                const localR = segLens[idx] === 0 ? 0 : (kmPos - prevKm) / segLens[idx];
                const a = pathPoints[idx], b = pathPoints[idx + 1];
                const lat = a[0] + (b[0] - a[0]) * localR;
                const lng = a[1] + (b[1] - a[1]) * localR;
                return [lat, lng];
            }
            _dispatchTimer = setInterval(() => {
                i++;
                const t = Math.min(i / steps, 1);
                const pos = posAtRatio(t);
                _dispatchMarker.setLatLng(pos);
                if (_dispatchRangeCircle) _dispatchRangeCircle.setLatLng(pos);
                if (t >= 1) {
                    clearInterval(_dispatchTimer);
                    _dispatchTimer = null;
                    if (_dispatchRangeCircle) { map.removeLayer(_dispatchRangeCircle); _dispatchRangeCircle = null; }
                    L.circle([currentTargetLat, currentTargetLng], { radius: 800, color: '#10b981', fillColor: '#10b981', fillOpacity: 0.1, weight: 2, dashArray: '4,6' }).addTo(selectionLayerGroup);
                    setTimeout(() => { showUavReturnIntel(); }, 500);
                }
            }, interval);
        }

        function showUavReturnIntel() {
            const popup = document.getElementById('intelPopup');
            const content = popup ? popup.querySelector('.popup-content') : null;
            if (content) {
                content.innerHTML = '<h4 style="margin:0 0 4px 0;font-size:14px;color:#ffffff;">无人机回传确认</h4>'+
                    '<p style="margin:0;font-size:12px;color:#cbd5e1;">确认目标为“鲍迪奇”号海洋测量船与拉尔夫·约翰逊号驱逐舰，预测概率提高至 95%，威胁评估降至中等。</p>';
                popup.classList.add('show');
                setTimeout(() => { popup.classList.remove('show'); }, 8000);
            }

            const newIntel = {
                title: '无人机回传：两舰型号识别与威胁评估更新',
                time: '刚刚',
                threat: '中等威胁',
                image: 'images/无人机拍摄船.png',
                images: ['无人机拍摄船.png','船.png'],
                desc: '系统通过视觉识别模型识别军舰型号，并与卫星图像和信号情报进行融合，确认目标为“鲍迪奇”号海洋测量船与拉尔夫·约翰逊号驱逐舰，预测概率提高至 95%，威胁评估从高降低至中等。'
            };
            intelData.unshift(newIntel);
            const idx = intelData.findIndex(d => d.title === '东部战区美国两艘舰艇过航台湾海峡');
            if (idx !== -1) intelData.splice(idx, 1);
            currentIntelIndex = 0;
            updateIntelDisplay();
            const badge = document.querySelector('#intelCard .monitor-header span:last-child');
            if (badge) badge.textContent = intelData.length + '条';
            const solutionCard = document.getElementById('solutionCard');
            if (solutionCard) solutionCard.style.display = 'flex';
            if (window.ship1Marker && window.ship2Marker && window._shipVectorDeg) {
                const moveKm = 15;
                const lat = window.ship1Marker.getLatLng().lat;
                const dxDeg = window._shipVectorDeg.dx;
                const dyDeg = window._shipVectorDeg.dy;
                const kmPerDegLat = 111.32;
                const kmPerDegLon = 111.32 * Math.cos(lat * Math.PI / 180);
                const totalKm = Math.sqrt(Math.pow(dxDeg * kmPerDegLat, 2) + Math.pow(dyDeg * kmPerDegLon, 2));
                const scale = moveKm / totalKm;
                const dLat = dxDeg * scale;
                const dLng = dyDeg * scale;
                const p1 = window.ship1Marker.getLatLng();
                const p2 = window.ship2Marker.getLatLng();
                window.ship1Marker.setLatLng([p1.lat + dLat, p1.lng + dLng]);
                window.ship2Marker.setLatLng([p2.lat + dLat, p2.lng + dLng]);
            }
        }

        // UAV Detail Logic
        function showUavDetails(e, title, type, range, endurance, payload) {
            e.stopPropagation(); // Prevent selection
            
            document.getElementById('uav-detail-title').textContent = title;
            document.getElementById('uav-detail-type').textContent = type;
            document.getElementById('uav-detail-range').textContent = range;
            document.getElementById('uav-detail-endurance').textContent = endurance;
            document.getElementById('uav-detail-payload').textContent = payload;

            document.getElementById('uav-detail-modal').style.display = 'flex';
            document.getElementById('overlay-backdrop').style.display = 'block';
        }

        function closeUavDetails() {
            document.getElementById('uav-detail-modal').style.display = 'none';
            document.getElementById('overlay-backdrop').style.display = 'none';
        }

        // Map Initialization (Leaflet)
        // Coords: 24.0589, 120.4333
        const map = L.map('map', {
            center: [24.0589, 120.4333],
            zoom: 14,
            zoomControl: false, // Custom look
            attributionControl: false
        });

        // Add Esri Satellite Layer
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19
        }).addTo(map);

        // Add Labels Layer (Reference)
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}').addTo(map);

        // Custom Icons
        const redMarkerIcon = L.divIcon({
            className: 'custom-marker-wrapper',
            html: '<div class="map-marker"></div>',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
        });

        const blueMarkerIcon = L.divIcon({
             className: 'custom-marker-wrapper',
             html: '<div class="map-marker" style="background: #3b82f6;"></div>',
             iconSize: [20, 20],
             iconAnchor: [10, 10]
         });

         // rangeCircleIcon removed - using L.circle instead

        // Add Initial Center Marker
        L.marker([24.0589, 120.4333], { icon: redMarkerIcon }).addTo(map);

        // Selection Logic
         const targetInput = document.getElementById('target-coords');
         const startCoordsInput = document.getElementById('uav-start-coords');
         const returnCoordsInput = document.getElementById('uav-return-coords');
         let selectionLayerGroup = L.layerGroup().addTo(map);
         let flightPathLayerGroup = L.layerGroup().addTo(map);
         let isPickingMode = false;
         let currentTargetLat = 24.0589;
         let currentTargetLng = 120.4333;

         // UAV Base Locations (Approximate for demo)
         const uavBases = {
             'uav-01': { lat: 24.25, lng: 118.10, name: 'Base A (Xiamen)' },
             'uav-02': { lat: 25.05, lng: 119.50, name: 'Base B (Pingtan)' },
             'uav-03': { lat: 23.50, lng: 117.00, name: 'Base C (Shantou)' }
         };

         function enableMapPicking() {
            isPickingMode = true;
            document.getElementById('map').style.cursor = 'crosshair';
            console.log("Map picking enabled. Click map to select.");
        }

        function disableMapPicking() {
            isPickingMode = false;
            document.getElementById('map').style.cursor = 'grab';
        }

        // Map Click Event
        map.on('click', function(e) {
            if (!isPickingMode) return;

            const lat = e.latlng.lat.toFixed(6);
            const lng = e.latlng.lng.toFixed(6);
            
            currentTargetLat = parseFloat(lat);
            currentTargetLng = parseFloat(lng);

            // Update Input
            targetInput.value = `${lat}°N, ${lng}°E`;

            // Clear previous selection
            selectionLayerGroup.clearLayers();
            flightPathLayerGroup.clearLayers(); // Clear flight paths on new target

            // Add Blue Marker
            L.marker([lat, lng], { icon: blueMarkerIcon }).addTo(selectionLayerGroup);

            // Add Range Circle (15km radius)
            // L.circle creates a circle with radius in meters that scales with the map
            L.circle([lat, lng], {
                radius: 15000, // 15km in meters
                color: '#3b82f6',
                dashArray: '10, 10',
                fillColor: '#3b82f6',
                fillOpacity: 0.1,
                weight: 2
            }).addTo(selectionLayerGroup);

            // Re-analyze UAV recommendations based on new location
            analyzeRecommendations(lat, lng);
            
            // Clear UAV selection inputs
            startCoordsInput.value = '';
            returnCoordsInput.value = '';
            document.querySelectorAll('.uav-option').forEach(opt => opt.classList.remove('selected'));
        });

        // Mock Analysis Function
        function analyzeRecommendations(lat, lng) {
            // In a real app, this would calculate distance from base to target (lat, lng)
            // Here we simulate dynamic changes to distance and recommendations
            
            // Randomize distances slightly to simulate different target location
            const d1 = Math.floor(Math.random() * 20) + 10; // 10-30km
            const d2 = Math.floor(Math.random() * 20) + 20; // 20-40km
            const d3 = Math.floor(Math.random() * 20) + 30; // 30-50km

            document.getElementById('dist-uav-01').textContent = d1 + 'km';
            document.getElementById('dist-uav-02').textContent = d2 + 'km';
            document.getElementById('dist-uav-03').textContent = d3 + 'km';

            // Logic: 
            // Time Optimal -> Shortest Distance
            // Cost Optimal -> Usually Long Range / Efficient (Let's say UAV-03 BZK is always most efficient)
            // Safety Optimal -> UAV-02 WL-2 (Assumed better defensive suite)

            // Reset badges
            document.getElementById('badge-uav-01').className = 'recommend-badge';
            document.getElementById('badge-uav-01').textContent = '';
            document.getElementById('badge-uav-01').style.display = 'none';

            document.getElementById('badge-uav-02').className = 'recommend-badge';
            document.getElementById('badge-uav-02').textContent = '';
            document.getElementById('badge-uav-02').style.display = 'none';

            document.getElementById('badge-uav-03').className = 'recommend-badge';
            document.getElementById('badge-uav-03').textContent = '';
            document.getElementById('badge-uav-03').style.display = 'none';

            // Find shortest distance for Time Optimal
            const dists = [{id: '01', d: d1}, {id: '02', d: d2}, {id: '03', d: d3}];
            dists.sort((a, b) => a.d - b.d);
            const shortest = dists[0];

            // Apply Time Optimal
            const timeBadge = document.getElementById('badge-uav-' + shortest.id);
            timeBadge.textContent = '时间最优';
            timeBadge.className = 'recommend-badge rec-time';
            timeBadge.style.display = 'inline-block';

            // Apply Safety Optimal (Static preference for WL-2 for demo, unless it's also time optimal, then maybe stack or just show one)
            // Let's assume WL-2 is always Safety Optimal
            if (shortest.id !== '02') {
                const safetyBadge = document.getElementById('badge-uav-02');
                safetyBadge.textContent = '安全性最优';
                safetyBadge.className = 'recommend-badge rec-safety';
                safetyBadge.style.display = 'inline-block';
            } else {
                 // If WL-2 is also time optimal, maybe append text or just leave as Time Optimal (User asked for re-analysis, simple logic for now)
                 // Or we can say WL-2 is Time & Safety
                 timeBadge.textContent = '时间/安全最优';
            }

            // Apply Cost Optimal (Static preference for BZK-005)
            if (shortest.id !== '03') {
                const costBadge = document.getElementById('badge-uav-03');
                costBadge.textContent = '效费比最优';
                costBadge.className = 'recommend-badge rec-cost';
                costBadge.style.display = 'inline-block';
            } else {
                 const combinedBadge = document.getElementById('badge-uav-03');
                 if (combinedBadge.textContent.includes('时间')) {
                     combinedBadge.textContent = '时间/效费比最优';
                 }
            }
        }

        // Enter key to confirm
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && isPickingMode) {
                disableMapPicking();
            }
        });

        /* 
           Old Overlay Logic removed since Leaflet handles interactions natively.
        */

        // Graticule (Lat/Lon Grid) Implementation
        const graticuleLayer = L.layerGroup().addTo(map);
        
        function updateGraticule() {
            graticuleLayer.clearLayers();
            const zoom = map.getZoom();
            
            // Determine interval based on zoom
            let interval = 10;
            if (zoom >= 5) interval = 5;
            if (zoom >= 7) interval = 1;
            if (zoom >= 10) interval = 0.5;
            if (zoom >= 12) interval = 0.1; // ~11km
            if (zoom >= 15) interval = 0.01; // ~1.1km

            const bounds = map.getBounds();
            const north = bounds.getNorth();
            const south = bounds.getSouth();
            const west = bounds.getWest();
            const east = bounds.getEast();

            // Style
            const lineStyle = {
                color: 'rgba(255, 255, 255, 0.3)',
                weight: 1,
                dashArray: '4, 4',
                interactive: false
            };

            // Draw Longitude Lines (Vertical)
            const startLng = Math.ceil(west / interval) * interval;
            const endLng = Math.floor(east / interval) * interval;
            
            for (let lng = startLng; lng <= endLng; lng += interval) {
                // Round to avoid float errors
                const currentLng = Math.round(lng * 1000) / 1000;
                
                L.polyline([[south, currentLng], [north, currentLng]], lineStyle).addTo(graticuleLayer);
                
                // Label (at top)
                const labelIcon = L.divIcon({
                    className: 'graticule-label',
                    html: `<span style="color: rgba(255,255,255,0.5); font-size: 10px; text-shadow: 1px 1px 2px black;">${currentLng.toFixed(getDecimals(interval))}°E</span>`,
                    iconSize: [40, 20],
                    iconAnchor: [20, -5]
                });
                // Place label slightly inside the top view
                L.marker([north, currentLng], { icon: labelIcon, interactive: false }).addTo(graticuleLayer);
            }

            // Draw Latitude Lines (Horizontal)
            const startLat = Math.ceil(south / interval) * interval;
            const endLat = Math.floor(north / interval) * interval;

            for (let lat = startLat; lat <= endLat; lat += interval) {
                const currentLat = Math.round(lat * 1000) / 1000;
                
                L.polyline([[currentLat, west], [currentLat, east]], lineStyle).addTo(graticuleLayer);
                
                // Label (at left)
                const labelIcon = L.divIcon({
                    className: 'graticule-label',
                    html: `<span style="color: rgba(255,255,255,0.5); font-size: 10px; text-shadow: 1px 1px 2px black;">${currentLat.toFixed(getDecimals(interval))}°N</span>`,
                    iconSize: [40, 20],
                    iconAnchor: [-5, 10]
                });
                // Place label slightly inside the left view
                L.marker([currentLat, west], { icon: labelIcon, interactive: false }).addTo(graticuleLayer);
            }
        }

        function getDecimals(interval) {
            if (interval >= 1) return 0;
            if (interval >= 0.1) return 1;
            if (interval >= 0.01) return 2;
            return 3;
        }

        map.on('moveend', updateGraticule);
        updateGraticule(); // Initial draw

    </script>
    <script>
            window._uavWaypoints = [];
            enableFlightPathEditing('uav-01');
        function enableFlightPathEditing(uavId) {
            if (!window._waypointMarkers) window._waypointMarkers = [];
            function addMarker(lat, lng) {
                const m = L.marker([lat, lng], {
                    draggable: true,
                    icon: L.divIcon({ className: 'wp-marker', html: '<div style="width:10px;height:10px;border-radius:50%;background:#f59e0b;border:2px solid white;"></div>', iconSize: [14,14], iconAnchor: [7,7] })
                }).addTo(flightPathLayerGroup);
                m.on('drag', () => {
                    const pos = m.getLatLng();
                    const idx = window._waypointMarkers.indexOf(m);
                    if (idx >= 0) window._uavWaypoints[idx] = [pos.lat, pos.lng];
                    updateFlightPath(uavId);
                });
                m.on('contextmenu', () => {
                    const idx = window._waypointMarkers.indexOf(m);
                    if (idx >= 0) {
                        flightPathLayerGroup.removeLayer(m);
                        window._waypointMarkers.splice(idx,1);
                        window._uavWaypoints.splice(idx,1);
                        updateFlightPath(uavId);
                    }
                });
                window._waypointMarkers.push(m);
            }
            function onAddWaypoint(e) {
                const { lat, lng } = e.latlng;
                window._uavWaypoints.push([lat, lng]);
                addMarker(lat, lng);
                updateFlightPath(uavId);
            }
            if (window._fpAddHandler) map.off('click', window._fpAddHandler);
            window._fpAddHandler = onAddWaypoint;
            map.on('click', onAddWaypoint);
        }
    </script>
